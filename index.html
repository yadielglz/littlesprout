<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LittleSprout - Baby Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
  <style>
    :root {
      --glass-bg: rgba(255,255,255,0.75);
      --glass-border: rgba(255,255,255,0.65);
      --glass-shadow: 0 8px 32px 0 rgba(31,38,135,0.15);
      --glass-blur: blur(20px) saturate(180%);
    }
    html.dark {
      --glass-bg: rgba(30,41,59,0.45);
      --glass-border: rgba(255,255,255,0.15);
      --glass-shadow: 0 8px 32px 0 rgba(0,0,0,0.35);
      --glass-blur: blur(20px) saturate(160%);
    }
    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(135deg, #e0e7ff 0%, #f0f5ff 100%);
      min-height: 100vh;
      color: #1e293b;
      transition: background 0.3s;
    }
    html.dark body {
      background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
      color: #f1f5f9;
    }
    .glass {
      background: var(--glass-bg);
      border: 1.5px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border-radius: 1.25rem;
      transition: all 0.3s;
    }
    .glass-sm {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      box-shadow: 0 2px 8px 0 rgba(31,38,135,0.10);
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);
      border-radius: 0.75rem;
      transition: all 0.3s;
    }
    .input-enhanced {
      background: rgba(241,245,249,0.8);
      border: 1px solid rgba(226,232,240,0.3);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: #1e293b;
    }
    .input-enhanced:focus {
      outline: none;
      border-color: rgba(102,126,234,0.5);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
      background: rgba(241,245,249,0.9);
    }
    html.dark .input-enhanced {
      background: rgba(51,65,85,0.8);
      border: 1px solid rgba(148,163,184,0.3);
      color: #f1f5f9;
    }
    html.dark .input-enhanced:focus {
      border-color: rgba(102,126,234,0.5);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
      background: rgba(51,65,85,0.9);
    }
    html.dark .input-enhanced::placeholder {
      color: #94a3b8;
    }
    @media (max-width: 640px) {
      .glass, .glass-sm { border-radius: 1rem; }
    }
    .focus-visible:focus {
      outline: 2px solid rgba(102,126,234,0.5);
      outline-offset: 2px;
    }
    
    /* Dark mode improvements for modals */
    html.dark .glass {
      background: rgba(30,41,59,0.85);
      border: 1.5px solid rgba(148,163,184,0.3);
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.5);
    }
    
    html.dark .glass-sm {
      background: rgba(30,41,59,0.85);
      border: 1px solid rgba(148,163,184,0.3);
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.3);
    }
    
    /* Improve text contrast in dark mode */
    html.dark .text-secondary {
      color: #cbd5e1 !important;
    }
    
    html.dark .text-primary {
      color: #f8fafc !important;
    }
    
    /* Better contrast for form labels in dark mode */
    html.dark label {
      color: #e2e8f0 !important;
    }
    
    /* Improve select dropdowns in dark mode */
    html.dark select {
      background-color: rgba(51,65,85,0.9);
      color: #f1f5f9;
      border-color: rgba(148,163,184,0.3);
    }
    
    html.dark select option {
      background-color: #334155;
      color: #f1f5f9;
    }
    
    /* Improve textarea styling in dark mode */
    html.dark textarea {
      background-color: rgba(51,65,85,0.9);
      color: #f1f5f9;
      border-color: rgba(148,163,184,0.3);
    }
    
    /* Improve date and time inputs in dark mode */
    html.dark input[type="date"],
    html.dark input[type="time"],
    html.dark input[type="datetime-local"] {
      background-color: rgba(51,65,85,0.9);
      color: #f1f5f9;
      border-color: rgba(148,163,184,0.3);
    }
    
    html.dark input[type="date"]::-webkit-calendar-picker-indicator,
    html.dark input[type="time"]::-webkit-calendar-picker-indicator,
    html.dark input[type="datetime-local"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }
    
    /* Better button contrast in dark mode */
    html.dark button:not([class*="bg-"]) {
      color: #f1f5f9;
    }
    
    /* Improve modal backdrop in dark mode */
    html.dark .fixed.inset-0.bg-black.bg-opacity-75 {
      background-color: rgba(0,0,0,0.85) !important;
    }
    
    /* Improve activity button hover states in dark mode */
    html.dark .timer-activity-btn:hover {
      background-color: rgba(51,65,85,0.8);
      border-color: rgba(148,163,184,0.5);
    }
    
    /* Better contrast for inventory items in dark mode */
    html.dark .inventory-item {
      background: rgba(51,65,85,0.8) !important;
      border: 1px solid rgba(148,163,184,0.2);
    }
    
    /* Improve mood button visibility in dark mode */
    html.dark .mood-btn,
    html.dark .edit-mood-btn {
      background-color: rgba(51,65,85,0.5);
      border-radius: 0.5rem;
      padding: 0.25rem;
    }
    
    html.dark .mood-btn:hover,
    html.dark .edit-mood-btn:hover {
      background-color: rgba(51,65,85,0.8);
    }
    
    /* Better contrast for stats panels in dark mode */
    html.dark .bg-white\/50 {
      background-color: rgba(51,65,85,0.8) !important;
    }
    
    /* Improve scrollbar visibility in dark mode */
    html.dark ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    html.dark ::-webkit-scrollbar-track {
      background: rgba(51,65,85,0.5);
      border-radius: 4px;
    }
    
    html.dark ::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.5);
      border-radius: 4px;
    }
    
    html.dark ::-webkit-scrollbar-thumb:hover {
      background: rgba(148,163,184,0.7);
    }
    
    /* Better button contrast in dark mode */
    html.dark button:not([class*="bg-"]) {
      color: #f1f5f9;
    }
    
    /* Improve modal backdrop in dark mode */
    html.dark .fixed.inset-0.bg-black.bg-opacity-75 {
      background-color: rgba(0,0,0,0.85) !important;
    }
    
    /* Ensure all text in modals is visible in dark mode */
    html.dark .glass h1,
    html.dark .glass h2,
    html.dark .glass h3,
    html.dark .glass h4,
    html.dark .glass h5,
    html.dark .glass h6 {
      color: #f8fafc !important;
    }
    
    html.dark .glass p {
      color: #e2e8f0 !important;
    }
    
    /* Improve form field spacing and visibility */
    html.dark .glass .space-y-4 > * + * {
      margin-top: 1rem;
    }
    
    html.dark .glass .space-y-3 > * + * {
      margin-top: 0.75rem;
    }
  </style>
</head>
<body class="transition-colors duration-300">
  <div id="app-container" class="glass container mx-auto p-4 md:p-6 max-w-lg mt-8">
    <header class="glass flex justify-between items-center mb-4 p-4 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-500 dark:from-slate-800 dark:to-indigo-900 shadow-lg text-white">
      <button onclick="showModal('profile-modal')" class="text-white/80 hover:text-white transition-colors w-8" title="Manage profiles">
        <i class="fas fa-users text-2xl"></i>
      </button>
      <div class="text-center">
        <h1 id="header-title" class="text-2xl sm:text-3xl font-bold">LittleSprout</h1>
        <p id="header-subtitle" class="text-white/80 mt-1"></p>
      </div>
      <button onclick="toggleDarkMode()" class="text-white/80 hover:text-white transition-colors w-8" title="Toggle dark mode">
        <i class="fas fa-moon text-2xl"></i>
      </button>
    </header>
    
    <!-- Clock Section -->
    <div class="glass-sm grid grid-cols-1 md:grid-cols-2 gap-4 items-center mb-4 p-4 overflow-hidden">
      <div id="main-clock-container" class="text-center md:text-left overflow-hidden">
        <div class="flex items-end justify-center md:justify-start flex-wrap overflow-hidden">
          <span id="main-time-display" class="text-5xl font-bold text-primary leading-none break-words overflow-hidden"></span>
          <span id="main-ampm-display" class="text-lg font-semibold text-secondary pb-1 ml-2 flex-shrink-0 overflow-hidden"></span>
        </div>
        <span id="main-date-display" class="text-base text-secondary block mt-1 break-words overflow-hidden"></span>
      </div>
      <div id="main-weather-display" class="text-secondary text-sm text-center md:text-right flex-shrink-0 overflow-hidden">
        <div class="flex items-center justify-center md:justify-end flex-wrap gap-2 overflow-hidden">
          <i class="weather-icon text-3xl flex-shrink-0"></i>
          <div class="weather-info text-center md:text-right overflow-hidden">
            <p class="weather-temp font-bold text-xl leading-none overflow-hidden"></p>
            <p class="weather-desc text-sm leading-tight overflow-hidden"></p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Baby Stats Bar -->
    <div id="header-stats-bar" class="glass-sm flex flex-wrap justify-center items-center gap-6 mb-6 p-3 text-center text-primary bg-gradient-to-r from-blue-100/40 to-purple-100/40 dark:from-slate-700/40 dark:to-indigo-800/40">
      <!-- Stats will be rendered here -->
    </div>
    <div id="milestone-ticker" class="glass-sm mb-6 p-4 bg-gradient-to-r from-yellow-400/20 to-orange-400/20 border-l-4 border-yellow-500">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i class="fas fa-trophy text-yellow-500 text-2xl"></i>
          <div>
            <h3 class="font-bold text-primary">Milestone Tracker</h3>
            <p id="milestone-text" class="text-sm text-secondary">Loading milestones...</p>
          </div>
        </div>
        <button onclick="showModal('milestone-modal')" class="text-sm bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition-colors">
          <i class="fas fa-plus mr-1"></i>Add
        </button>
      </div>
    </div>
    <div id="activity-timer" class="glass-sm mb-6 p-4 bg-gradient-to-r from-blue-400/20 to-indigo-400/20 border-l-4 border-blue-500">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-3">
          <i class="fas fa-clock text-blue-500 text-2xl"></i>
          <div>
            <h3 class="font-bold text-primary">Activity Timer</h3>
            <p id="timer-status" class="text-sm text-secondary">No active timer</p>
          </div>
        </div>
        <div id="timer-controls" class="flex space-x-2">
          <button id="start-timer-btn" onclick="startTimer()" class="text-sm bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition-colors">
            <i class="fas fa-play mr-1"></i>Start
          </button>
          <button id="stop-timer-btn" onclick="stopTimer()" class="text-sm bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition-colors hidden">
            <i class="fas fa-stop mr-1"></i>Stop
          </button>
          <button onclick="showModal('timer-settings-modal')" class="text-sm bg-gray-500 text-white px-3 py-1 rounded-lg hover:bg-gray-600 transition-colors">
            <i class="fas fa-cog mr-1"></i>Settings
          </button>
        </div>
      </div>
      <div id="timer-display" class="text-center hidden">
        <div class="text-3xl font-bold text-primary mb-2" id="timer-time">00:00:00</div>
        <div class="text-sm text-secondary" id="timer-activity">Activity: None</div>
      </div>
      <div id="timer-selection" class="grid grid-cols-3 gap-2 mt-3">
        <button onclick="selectTimerActivity('sleep')" class="timer-activity-btn p-2 rounded-lg border-2 border-transparent hover:border-blue-300 transition-colors text-center">
          <i class="fas fa-moon text-indigo-500 text-xl mb-1"></i>
          <div class="text-xs font-medium">Sleep</div>
        </button>
        <button onclick="selectTimerActivity('nap')" class="timer-activity-btn p-2 rounded-lg border-2 border-transparent hover:border-blue-300 transition-colors text-center">
          <i class="fas fa-bed text-purple-500 text-xl mb-1"></i>
          <div class="text-xs font-medium">Nap</div>
        </button>
        <button onclick="selectTimerActivity('tummy')" class="timer-activity-btn p-2 rounded-lg border-2 border-transparent hover:border-blue-300 transition-colors text-center">
          <i class="fas fa-child-reaching text-lime-500 text-xl mb-1"></i>
          <div class="text-xs font-medium">Tummy Time</div>
        </button>
      </div>
    </div>
    <div id="inventory-section" class="glass-sm mb-6 p-4 bg-gradient-to-r from-green-400/20 to-emerald-400/20 border-l-4 border-green-500">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <i class="fas fa-boxes text-green-500 text-2xl"></i>
          <div>
            <h3 class="font-bold text-primary">Inventory Tracker</h3>
            <p class="text-sm text-secondary">Track baby supplies</p>
          </div>
        </div>
        <button onclick="showModal('inventory-modal')" class="text-sm bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition-colors">
          <i class="fas fa-plus mr-1"></i>Add Item
        </button>
      </div>
      <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="inventory-item bg-white/50 dark:bg-slate-800/50 rounded-lg p-3 text-center">
          <i class="fas fa-baby text-amber-500 text-2xl mb-2"></i>
          <div class="font-semibold text-primary">Diapers</div>
          <div id="diapers-count" class="text-lg font-bold text-green-600">0</div>
          <div class="text-xs text-secondary">remaining</div>
        </div>
        <div class="inventory-item bg-white/50 dark:bg-slate-800/50 rounded-lg p-3 text-center">
          <i class="fas fa-wind text-blue-500 text-2xl mb-2"></i>
          <div class="font-semibold text-primary">Wipes</div>
          <div id="wipes-count" class="text-lg font-bold text-green-600">0</div>
          <div class="text-xs text-secondary">remaining</div>
        </div>
        <div class="inventory-item bg-white/50 dark:bg-slate-800/50 rounded-lg p-3 text-center">
          <i class="fas fa-baby-carriage text-purple-500 text-2xl mb-2"></i>
          <div class="font-semibold text-primary">Formula</div>
          <div id="formula-count" class="text-lg font-bold text-green-600">0</div>
          <div class="text-xs text-secondary">bottles</div>
        </div>
        <div class="inventory-item bg-white/50 dark:bg-slate-800/50 rounded-lg p-3 text-center">
          <i class="fas fa-pills text-cyan-500 text-2xl mb-2"></i>
          <div class="font-semibold text-primary">Medicine</div>
          <div id="medicine-count" class="text-lg font-bold text-green-600">0</div>
          <div class="text-xs text-secondary">doses</div>
        </div>
      </div>
    </div>
    <div id="main-activity-buttons" class="glass-sm mb-6 p-4 overflow-x-auto"></div>
    <div id="activity-log-container" class="glass-sm mb-6 p-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-primary">Recent Activities</h3>
        <button onclick="showModal('log-modal')" class="text-sm bg-indigo-500 text-white px-3 py-1 rounded-lg hover:bg-indigo-600 transition-colors">
          <i class="fas fa-plus mr-1"></i>Add Entry
        </button>
      </div>
      <div id="activity-log" class="space-y-2 max-h-64 overflow-y-auto"></div>
    </div>
    <div id="mood-analytics-container" class="glass-sm mb-6 p-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-primary">Mood Analytics</h3>
        <button onclick="showModal('backup-modal')" class="text-sm bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition-colors">
          <i class="fas fa-download mr-1"></i>Backup
        </button>
      </div>
      <div id="mood-analytics" class="text-center py-4">
        <p class="text-secondary">Log mood activities to see analytics here!</p>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="glass-sm p-4 text-center cursor-pointer hover:bg-white/20 transition-colors" onclick="showModal('growth-modal')">
        <i class="fas fa-chart-line text-3xl text-blue-500 mb-2"></i>
        <h3 class="font-bold text-primary">Growth Chart</h3>
        <p class="text-sm text-secondary">Track height & weight</p>
      </div>
      <div class="glass-sm p-4 text-center cursor-pointer hover:bg-white/20 transition-colors" onclick="showModal('tot-report-modal')">
        <i class="fas fa-file-alt text-3xl text-green-500 mb-2"></i>
        <h3 class="font-bold text-primary">Tot Report</h3>
        <p class="text-sm text-secondary">Daily summary</p>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="glass-sm p-4 text-center cursor-pointer hover:bg-white/20 transition-colors" onclick="showModal('feeding-schedule-modal')">
        <i class="fas fa-clock text-3xl text-purple-500 mb-2"></i>
        <h3 class="font-bold text-primary">Feeding Schedule</h3>
        <p class="text-sm text-secondary">Plan & track feeds</p>
      </div>
      <div class="glass-sm p-4 text-center cursor-pointer hover:bg-white/20 transition-colors" onclick="showModal('reminders-modal')">
        <i class="fas fa-bell text-3xl text-orange-500 mb-2"></i>
        <h3 class="font-bold text-primary">Reminders</h3>
        <p class="text-sm text-secondary">Set notifications</p>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="glass-sm p-4 text-center cursor-pointer hover:bg-white/20 transition-colors" onclick="showModal('appointment-modal')">
        <i class="fas fa-user-md text-3xl text-blue-500 mb-2"></i>
        <h3 class="font-bold text-primary">Doctor's Appointments</h3>
        <p class="text-sm text-secondary">Track medical visits</p>
      </div>
      <div class="glass-sm p-4 text-center cursor-pointer hover:bg-white/20 transition-colors" onclick="showModal('backup-modal')">
        <i class="fas fa-download text-3xl text-green-500 mb-2"></i>
        <h3 class="font-bold text-primary">Backup & Restore</h3>
        <p class="text-sm text-secondary">Export/import data</p>
      </div>
    </div>
  </div>
  <!-- Onboarding & Profile Management Modals -->
  <div id="welcome-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-8 rounded-2xl shadow-2xl w-full max-w-md text-center animate-fadeIn">
      <h2 class="text-3xl font-bold mb-2">Welcome to LittleSprout!</h2>
      <p class="text-secondary mb-8">Let's get you started.</p>
      <div class="space-y-4">
        <button onclick="showModal('setup-modal'); hideModal('welcome-modal');" class="w-full bg-indigo-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-indigo-700 transition-colors text-lg flex items-center justify-center gap-3"><i class="fas fa-baby"></i> I'm a new user</button>
      </div>
    </div>
  </div>
  <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-8 rounded-2xl shadow-2xl w-full max-w-md animate-fadeIn">
      <h2 id="setup-title" class="text-2xl font-bold mb-2">Welcome!</h2>
      <p id="setup-subtitle" class="text-secondary mb-6">Let's get you and your little one set up.</p>
      <div class="space-y-4">
        <div><label for="user-name" class="block text-sm font-medium text-secondary">Your Name</label><input type="text" id="user-name" class="mt-1 block w-full input-enhanced" placeholder="e.g., Sarah"></div>
        <div><label for="baby-name" class="block text-sm font-medium text-secondary">Baby's Name</label><input type="text" id="baby-name" class="mt-1 block w-full input-enhanced" placeholder="e.g., Charlie"></div>
        <div><label for="baby-dob" class="block text-sm font-medium text-secondary">Date of Birth</label><input type="date" id="baby-dob" class="mt-1 block w-full input-enhanced"></div>
        <button onclick="saveBabyInfo()" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors mt-4">Save and Start Tracking</button>
      </div>
    </div>
  </div>
  <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-sm">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Manage Profiles</h2>
        <button onclick="hideModal('profile-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="space-y-3">
        <select id="profile-switcher" onchange="switchProfile()" class="input-enhanced w-full"></select>
        <button onclick="showSetupForNewProfile()" class="w-full bg-indigo-500 text-white font-bold p-2 rounded-lg hover:bg-indigo-600 transition-colors text-sm flex items-center justify-center gap-2"><i class="fas fa-plus"></i> Add New Profile</button>
        <button onclick="deleteCurrentProfile()" class="w-full bg-red-500 text-white font-bold p-2 rounded-lg hover:bg-red-600 transition-colors text-sm flex items-center justify-center gap-2"><i class="fas fa-trash-alt"></i> Delete Current Profile</button>
        <div class="border-t pt-3">
          <button onclick="showResetAppModal()" class="w-full bg-red-600 text-white font-bold p-2 rounded-lg hover:bg-red-700 transition-colors text-sm flex items-center justify-center gap-2"><i class="fas fa-exclamation-triangle"></i> Reset App (Delete All Data)</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Reset App Modal -->
  <div id="reset-app-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-red-600">‚ö†Ô∏è Reset App</h2>
        <button onclick="hideModal('reset-app-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="space-y-4">
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
          <h3 class="font-semibold text-red-700 dark:text-red-300 mb-2">‚ö†Ô∏è Warning: This action cannot be undone!</h3>
          <p class="text-sm text-red-600 dark:text-red-400">
            This will permanently delete ALL data including:
          </p>
          <ul class="text-sm text-red-600 dark:text-red-400 mt-2 space-y-1">
            <li>‚Ä¢ All baby profiles</li>
            <li>‚Ä¢ Activity logs</li>
            <li>‚Ä¢ Growth data</li>
            <li>‚Ä¢ Milestones</li>
            <li>‚Ä¢ Feeding schedules</li>
            <li>‚Ä¢ Reminders</li>
            <li>‚Ä¢ Appointments</li>
            <li>‚Ä¢ Inventory data</li>
            <li>‚Ä¢ Mood analytics</li>
          </ul>
        </div>
        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
          <h4 class="font-semibold text-yellow-700 dark:text-yellow-300 mb-2">üí° Recommendation</h4>
          <p class="text-sm text-yellow-600 dark:text-yellow-400">
            Consider backing up your data first using the Backup & Restore feature before resetting.
          </p>
        </div>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-secondary mb-1">Type "RESET" to confirm</label>
            <input type="text" id="reset-confirmation" class="input-enhanced w-full" placeholder="Type RESET to confirm deletion" maxlength="5">
          </div>
          <div class="flex space-x-3">
            <button onclick="hideModal('reset-app-modal')" class="flex-1 bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors">
              Cancel
            </button>
            <button onclick="confirmResetApp()" class="flex-1 bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" id="reset-confirm-btn" disabled>
              Reset App
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="backup-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Backup & Restore</h2>
        <button onclick="hideModal('backup-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="space-y-4">
        <div>
          <h3 class="font-semibold mb-2">Backup Data</h3>
          <p class="text-sm text-secondary mb-3">Download all your baby tracking data as a JSON file.</p>
          <button onclick="exportData()" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
            <i class="fas fa-download mr-2"></i>Export Data
          </button>
        </div>
        <div class="border-t pt-4">
          <h3 class="font-semibold mb-2">Restore Data</h3>
          <p class="text-sm text-secondary mb-3">Upload a previously exported JSON file to restore your data.</p>
          <input type="file" id="restore-file" accept=".json" class="hidden">
          <button onclick="document.getElementById('restore-file').click()" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
            <i class="fas fa-upload mr-2"></i>Import Data
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Activity Log Modal -->
  <div id="log-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Log Activity</h2>
        <button onclick="hideModal('log-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <form id="activity-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Activity Type</label>
          <select id="activity-type" class="input-enhanced w-full" required onchange="toggleFeedQuantityField()">
            <option value="">Select activity...</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Time</label>
          <input type="datetime-local" id="activity-time" class="input-enhanced w-full" required>
        </div>
        <div id="feed-quantity-section" class="hidden">
          <label class="block text-sm font-medium text-secondary mb-1">Feed Type</label>
          <select id="feed-type" class="input-enhanced w-full" required>
            <option value="">Select feed type...</option>
            <option value="breast">Breast Feeding</option>
            <option value="formula">Formula</option>
          </select>
          <label class="block text-sm font-medium text-secondary mb-1 mt-3">Quantity (oz)</label>
          <input type="number" id="feed-quantity" class="input-enhanced w-full" min="0" step="0.5" placeholder="e.g., 4.5">
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Notes (optional)</label>
          <textarea id="activity-notes" class="input-enhanced w-full h-20 resize-none" placeholder="Add any notes..."></textarea>
        </div>
        <div id="mood-section" class="hidden">
          <label class="block text-sm font-medium text-secondary mb-1">Mood</label>
          <div class="flex justify-center space-x-4">
            <button type="button" class="mood-btn text-3xl hover:scale-110 transition-transform" data-mood="üò¢">üò¢</button>
            <button type="button" class="mood-btn text-3xl hover:scale-110 transition-transform" data-mood="üòê">üòê</button>
            <button type="button" class="mood-btn text-3xl hover:scale-110 transition-transform" data-mood="üôÇ">üôÇ</button>
            <button type="button" class="mood-btn text-3xl hover:scale-110 transition-transform" data-mood="üòä">üòä</button>
            <button type="button" class="mood-btn text-3xl hover:scale-110 transition-transform" data-mood="üòÑ">üòÑ</button>
          </div>
        </div>
        <div id="inventory-status-section" class="hidden">
          <label class="block text-sm font-medium text-secondary mb-1">Inventory Impact</label>
          <div id="inventory-impact" class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 text-sm">
            <div class="flex items-center space-x-2 mb-2">
              <i class="fas fa-info-circle text-blue-500"></i>
              <span class="font-medium text-blue-700 dark:text-blue-300">This activity will use:</span>
            </div>
            <div id="inventory-impact-items" class="space-y-1">
              <!-- Items will be populated by JavaScript -->
            </div>
          </div>
        </div>
        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
          Save Activity
        </button>
      </form>
    </div>
  </div>
  <!-- Milestone Modal -->
  <div id="milestone-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Add Milestone</h2>
        <button onclick="hideModal('milestone-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <form id="milestone-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Milestone Type</label>
          <select id="milestone-type" class="input-enhanced w-full" required>
            <option value="">Select milestone...</option>
            <option value="first-smile">First Smile</option>
            <option value="first-roll">First Roll</option>
            <option value="first-sit">First Sit</option>
            <option value="first-crawl">First Crawl</option>
            <option value="first-step">First Step</option>
            <option value="first-word">First Word</option>
            <option value="first-tooth">First Tooth</option>
            <option value="custom">Custom Milestone</option>
          </select>
        </div>
        <div id="custom-milestone-input" class="hidden">
          <label class="block text-sm font-medium text-secondary mb-1">Custom Milestone</label>
          <input type="text" id="custom-milestone-text" class="input-enhanced w-full" placeholder="e.g., First laugh">
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Date Achieved</label>
          <input type="date" id="milestone-date" class="input-enhanced w-full" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Notes (optional)</label>
          <textarea id="milestone-notes" class="input-enhanced w-full h-20 resize-none" placeholder="Add any details..."></textarea>
        </div>
        <button type="submit" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 transition-colors">
          Save Milestone
        </button>
      </form>
    </div>
  </div>
  <!-- Growth Chart Modal -->
  <div id="growth-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Growth Chart</h2>
        <button onclick="hideModal('growth-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Add Measurement Form -->
        <div>
          <h3 class="font-semibold mb-3">Add Measurement</h3>
          <form id="growth-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">Measurement Type</label>
              <select id="measurement-type" class="input-enhanced w-full" required onchange="updateMeasurementFields()">
                <option value="">Select type...</option>
                <option value="weight">Weight</option>
                <option value="height">Height</option>
                <option value="head-circumference">Head Circumference</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">Unit</label>
              <select id="measurement-unit" class="input-enhanced w-full" required onchange="updateMeasurementFields()">
                <option value="">Select unit first...</option>
                <option value="lbs" data-type="weight">Pounds (lbs)</option>
                <option value="kg" data-type="weight">Kilograms (kg)</option>
                <option value="in" data-type="height,head-circumference">Inches (in)</option>
                <option value="cm" data-type="height,head-circumference">Centimeters (cm)</option>
                <option value="ft-in" data-type="height">Feet & Inches (ft-in)</option>
                <option value="m-cm" data-type="height">Meters & Centimeters (m-cm)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">
                <span id="value-label">Value</span>
                <span id="format-hint" class="text-xs text-gray-500 ml-2"></span>
              </label>
              <input type="text" id="measurement-value" class="input-enhanced w-full" required>
              <div id="input-help" class="text-xs text-secondary mt-1"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">Date</label>
              <input type="date" id="measurement-date" class="input-enhanced w-full" required>
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">
              Add Measurement
            </button>
          </form>
        </div>
        
        <!-- Visual Chart -->
        <div class="lg:col-span-2">
          <h3 class="font-semibold mb-3">Growth Chart</h3>
          <div class="space-y-4">
            <!-- Chart Type Selector -->
            <div class="flex space-x-2 mb-4">
              <button onclick="showGrowthChart('weight')" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                Weight Chart
              </button>
              <button onclick="showGrowthChart('height')" class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm">
                Height Chart
              </button>
              <button onclick="showGrowthChart('head')" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-sm">
                Head Circumference
              </button>
            </div>
            
            <!-- Chart Container -->
            <div id="growth-chart-container" class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4 min-h-64">
              <div id="growth-chart" class="text-center py-8">
                <p class="text-secondary">Select a chart type to view growth data</p>
              </div>
            </div>
            
            <!-- Growth History -->
            <div>
              <h4 class="font-semibold mb-3">Recent Measurements</h4>
              <div id="growth-history" class="space-y-2 max-h-48 overflow-y-auto">
                <p class="text-secondary text-center py-4">No measurements recorded yet.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Tot Report Modal -->
  <div id="tot-report-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Daily Tot Report</h2>
        <button onclick="hideModal('tot-report-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Report Generation -->
        <div class="lg:col-span-2">
          <div class="space-y-4">
            <div class="flex space-x-4 mb-4">
              <input type="date" id="report-date" class="input-enhanced flex-1" onchange="generateTotReport()">
              <button onclick="generateTotReport()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                Generate Report
              </button>
            </div>
            <div id="tot-report-content" class="space-y-4">
              <p class="text-secondary text-center py-8">Select a date to generate a daily report.</p>
            </div>
          </div>
        </div>
        <!-- Daily Stats Panel -->
        <div class="lg:col-span-1">
          <h3 class="font-semibold mb-4">Today's Quick Stats</h3>
          <div id="daily-stats-panel" class="space-y-4">
            <div class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4">
              <h4 class="font-semibold text-primary mb-3">Feeding</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span>Total Feeds:</span>
                  <span id="stats-feeds" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                  <span>Last Feed:</span>
                  <span id="stats-last-feed" class="font-medium">-</span>
                </div>
                <div class="flex justify-between">
                  <span>Avg Interval:</span>
                  <span id="stats-feed-interval" class="font-medium">-</span>
                </div>
                <div class="flex justify-between">
                  <span>Total Intake:</span>
                  <span id="stats-feed-quantity" class="font-medium">0 oz</span>
                </div>
              </div>
            </div>
            <div class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4">
              <h4 class="font-semibold text-primary mb-3">Diapers</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span>Total Changes:</span>
                  <span id="stats-diapers" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                  <span>Last Change:</span>
                  <span id="stats-last-diaper" class="font-medium">-</span>
                </div>
                <div class="flex justify-between">
                  <span>Wet:</span>
                  <span id="stats-wet-diapers" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                  <span>Dirty:</span>
                  <span id="stats-dirty-diapers" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                  <span>Wet & Dirty:</span>
                  <span id="stats-wet-dirty-diapers" class="font-medium">0</span>
                </div>
              </div>
            </div>
            <div class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4">
              <h4 class="font-semibold text-primary mb-3">Sleep</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span>Total Sleep:</span>
                  <span id="stats-sleep-time" class="font-medium">0h</span>
                </div>
                <div class="flex justify-between">
                  <span>Naps:</span>
                  <span id="stats-naps" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                  <span>Avg Nap:</span>
                  <span id="stats-avg-nap" class="font-medium">-</span>
                </div>
              </div>
            </div>
            <div class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4">
              <h4 class="font-semibold text-primary mb-3">Inventory</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span>Diapers Left:</span>
                  <span id="stats-diapers-left" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                  <span>Wipes Left:</span>
                  <span id="stats-wipes-left" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                  <span>Formula Left:</span>
                  <span id="stats-formula-left" class="font-medium">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Feeding Schedule Modal -->
  <div id="feeding-schedule-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Feeding Schedule</h2>
        <button onclick="hideModal('feeding-schedule-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <h3 class="font-semibold">Today's Schedule</h3>
          <button onclick="showModal('add-schedule-modal')" class="bg-purple-500 text-white px-3 py-1 rounded-lg hover:bg-purple-600 transition-colors text-sm">
            <i class="fas fa-plus mr-1"></i>Add Time
          </button>
        </div>
        <div id="feeding-schedule-list" class="space-y-2">
          <p class="text-secondary text-center py-4">No feeding schedule set for today.</p>
        </div>
      </div>
    </div>
  </div>
  <!-- Add Schedule Modal -->
  <div id="add-schedule-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Add Feeding Time</h2>
        <button onclick="hideModal('add-schedule-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <form id="add-schedule-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Feeding Type</label>
          <select id="schedule-feeding-type" class="input-enhanced w-full" required>
            <option value="">Select type...</option>
            <option value="breast">Breastfeeding</option>
            <option value="bottle">Bottle Feeding</option>
            <option value="solid">Solid Food</option>
            <option value="snack">Snack</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Time</label>
          <input type="time" id="schedule-time" class="input-enhanced w-full" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Notes (optional)</label>
          <textarea id="schedule-notes" class="input-enhanced w-full h-20 resize-none" placeholder="e.g., 4 oz formula, rice cereal..."></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Repeat</label>
          <select id="schedule-repeat" class="input-enhanced w-full">
            <option value="once">Just today</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
          </select>
        </div>
        <button type="submit" class="w-full bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600 transition-colors">
          Add to Schedule
        </button>
      </form>
    </div>
  </div>
  <!-- Timer Settings Modal -->
  <div id="timer-settings-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Timer Settings</h2>
        <button onclick="hideModal('timer-settings-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="space-y-4">
        <div>
          <h3 class="font-semibold mb-3">Quick Timer</h3>
          <div class="grid grid-cols-2 gap-2">
            <button onclick="startQuickTimer('sleep', 30)" class="p-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors text-center">
              <div class="text-lg font-bold">30 min</div>
              <div class="text-sm">Sleep</div>
            </button>
            <button onclick="startQuickTimer('nap', 60)" class="p-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-center">
              <div class="text-lg font-bold">1 hour</div>
              <div class="text-sm">Nap</div>
            </button>
            <button onclick="startQuickTimer('tummy', 15)" class="p-3 bg-lime-500 text-white rounded-lg hover:bg-lime-600 transition-colors text-center">
              <div class="text-lg font-bold">15 min</div>
              <div class="text-sm">Tummy Time</div>
            </button>
            <button onclick="startQuickTimer('tummy', 30)" class="p-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-center">
              <div class="text-lg font-bold">30 min</div>
              <div class="text-sm">Tummy Time</div>
            </button>
          </div>
        </div>
        <div class="border-t pt-4">
          <h3 class="font-semibold mb-3">Custom Timer</h3>
          <form id="custom-timer-form" class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">Activity</label>
              <select id="custom-timer-activity" class="input-enhanced w-full" required>
                <option value="">Select activity...</option>
                <option value="sleep">Sleep</option>
                <option value="nap">Nap</option>
                <option value="tummy">Tummy Time</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">Duration (minutes)</label>
              <input type="number" id="custom-timer-duration" class="input-enhanced w-full" min="1" max="480" placeholder="30" required>
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">
              Start Custom Timer
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Inventory Modal -->
  <div id="inventory-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Manage Inventory</h2>
        <button onclick="hideModal('inventory-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="space-y-4">
        <div>
          <h3 class="font-semibold mb-3">Add/Update Items</h3>
          <form id="inventory-form" class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">Item Type</label>
              <select id="inventory-item-type" class="input-enhanced w-full" required>
                <option value="">Select item...</option>
                <option value="diapers">Diapers</option>
                <option value="wipes">Wipes</option>
                <option value="formula">Formula</option>
                <option value="medicine">Medicine</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">Quantity</label>
              <input type="number" id="inventory-quantity" class="input-enhanced w-full" min="0" placeholder="0" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">Action</label>
              <select id="inventory-action" class="input-enhanced w-full" required>
                <option value="add">Add to inventory</option>
                <option value="use">Use/Consume</option>
                <option value="set">Set exact amount</option>
              </select>
            </div>
            <button type="submit" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors">
              Update Inventory
            </button>
          </form>
        </div>
        <div class="border-t pt-4">
          <h3 class="font-semibold mb-3">Quick Actions</h3>
          <div class="grid grid-cols-2 gap-2">
            <button onclick="quickInventoryAction('diapers', 'use', 1)" class="p-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors text-center text-sm">
              <i class="fas fa-baby mr-1"></i>Use Diaper
            </button>
            <button onclick="quickInventoryAction('wipes', 'use', 1)" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-center text-sm">
              <i class="fas fa-wind mr-1"></i>Use Wipe
            </button>
            <button onclick="quickInventoryAction('formula', 'use', 1)" class="p-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-center text-sm">
              <i class="fas fa-baby-carriage mr-1"></i>Use Formula
            </button>
            <button onclick="quickInventoryAction('medicine', 'use', 1)" class="p-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors text-center text-sm">
              <i class="fas fa-pills mr-1"></i>Use Medicine
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Activity Editor Modal -->
  <div id="activity-editor-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Edit Activity</h2>
        <button onclick="hideModal('activity-editor-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <form id="activity-editor-form" class="space-y-4">
        <input type="hidden" id="edit-activity-id">
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Activity Type</label>
          <select id="edit-activity-type" class="input-enhanced w-full" required onchange="toggleEditFeedQuantityField()">
            <option value="">Select activity...</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Time</label>
          <input type="datetime-local" id="edit-activity-time" class="input-enhanced w-full" required>
        </div>
        <div id="edit-feed-quantity-section" class="hidden">
          <label class="block text-sm font-medium text-secondary mb-1">Feed Type</label>
          <select id="edit-feed-type" class="input-enhanced w-full" required>
            <option value="">Select feed type...</option>
            <option value="breast">Breast Feeding</option>
            <option value="formula">Formula</option>
          </select>
          <label class="block text-sm font-medium text-secondary mb-1 mt-3">Quantity (oz)</label>
          <input type="number" id="edit-feed-quantity" class="input-enhanced w-full" min="0" step="0.5" placeholder="e.g., 4.5">
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Notes (optional)</label>
          <textarea id="edit-activity-notes" class="input-enhanced w-full h-20 resize-none" placeholder="Add any notes..."></textarea>
        </div>
        <div id="edit-mood-section" class="hidden">
          <label class="block text-sm font-medium text-secondary mb-1">Mood</label>
          <div class="flex justify-center space-x-4">
            <button type="button" class="edit-mood-btn text-3xl hover:scale-110 transition-transform" data-mood="üò¢">üò¢</button>
            <button type="button" class="edit-mood-btn text-3xl hover:scale-110 transition-transform" data-mood="üòê">üòê</button>
            <button type="button" class="edit-mood-btn text-3xl hover:scale-110 transition-transform" data-mood="üôÇ">üôÇ</button>
            <button type="button" class="edit-mood-btn text-3xl hover:scale-110 transition-transform" data-mood="üòä">üòä</button>
            <button type="button" class="edit-mood-btn text-3xl hover:scale-110 transition-transform" data-mood="üòÑ">üòÑ</button>
          </div>
        </div>
        <div id="edit-inventory-status-section" class="hidden">
          <label class="block text-sm font-medium text-secondary mb-1">Inventory Impact</label>
          <div id="edit-inventory-impact" class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 text-sm">
            <div class="flex items-center space-x-2 mb-2">
              <i class="fas fa-info-circle text-blue-500"></i>
              <span class="font-medium text-blue-700 dark:text-blue-300">This activity will use:</span>
            </div>
            <div id="edit-inventory-impact-items" class="space-y-1">
              <!-- Items will be populated by JavaScript -->
            </div>
          </div>
        </div>
        <div class="flex space-x-3">
          <button type="submit" class="flex-1 bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">
            Save Changes
          </button>
          <button type="button" onclick="deleteActivity()" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors">
            Delete
          </button>
        </div>
      </form>
    </div>
  </div>
  <!-- Reminders Modal -->
  <div id="reminders-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Reminders</h2>
        <button onclick="hideModal('reminders-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <h3 class="font-semibold">Active Reminders</h3>
          <button onclick="showModal('add-reminder-modal')" class="bg-orange-500 text-white px-3 py-1 rounded-lg hover:bg-orange-600 transition-colors text-sm">
            <i class="fas fa-plus mr-1"></i>Add
          </button>
        </div>
        <div id="reminders-list" class="space-y-2">
          <p class="text-secondary text-center py-4">No reminders set.</p>
        </div>
      </div>
    </div>
  </div>
  <!-- Add Reminder Modal -->
  <div id="add-reminder-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Add Reminder</h2>
        <button onclick="hideModal('add-reminder-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <form id="add-reminder-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Reminder Type</label>
          <select id="reminder-type" class="input-enhanced w-full" required>
            <option value="">Select type...</option>
            <option value="feed">Feeding</option>
            <option value="diaper">Diaper Change</option>
            <option value="sleep">Sleep/Nap</option>
            <option value="medicine">Medicine</option>
            <option value="appointment">Appointment</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div id="custom-reminder-input" class="hidden">
          <label class="block text-sm font-medium text-secondary mb-1">Custom Reminder</label>
          <input type="text" id="custom-reminder-text" class="input-enhanced w-full" placeholder="e.g., Tummy time, Bath time...">
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Time</label>
          <input type="time" id="reminder-time" class="input-enhanced w-full" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Date</label>
          <input type="date" id="reminder-date" class="input-enhanced w-full" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Notes (optional)</label>
          <textarea id="reminder-notes" class="input-enhanced w-full h-20 resize-none" placeholder="Add any additional details..."></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Repeat</label>
          <select id="reminder-repeat" class="input-enhanced w-full">
            <option value="once">Just once</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
          </select>
        </div>
        <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors">
          Add Reminder
        </button>
      </form>
    </div>
  </div>
  <!-- Doctor's Appointment Modal -->
  <div id="appointment-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Doctor's Appointments</h2>
        <button onclick="hideModal('appointment-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Appointment List -->
        <div class="lg:col-span-2">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold">Upcoming Appointments</h3>
            <button onclick="showModal('add-appointment-modal')" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition-colors text-sm">
              <i class="fas fa-plus mr-1"></i>Add Appointment
            </button>
          </div>
          <div id="appointments-list" class="space-y-3">
            <p class="text-secondary text-center py-4">No appointments scheduled.</p>
          </div>
        </div>
        <!-- Quick Stats -->
        <div class="lg:col-span-1">
          <h3 class="font-semibold mb-4">Appointment Stats</h3>
          <div class="space-y-4">
            <div class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4">
              <h4 class="font-semibold text-primary mb-3">This Month</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span>Upcoming:</span>
                  <span id="stats-upcoming" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                  <span>Completed:</span>
                  <span id="stats-completed" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                  <span>Next Visit:</span>
                  <span id="stats-next-visit" class="font-medium">-</span>
                </div>
              </div>
            </div>
            <div class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4">
              <h4 class="font-semibold text-primary mb-3">Recent Visits</h4>
              <div id="recent-visits" class="space-y-2 text-sm">
                <p class="text-secondary text-center">No recent visits</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Add Appointment Modal -->
  <div id="add-appointment-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Add Doctor's Appointment</h2>
        <button onclick="hideModal('add-appointment-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <form id="add-appointment-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-secondary mb-1">Appointment Date</label>
            <input type="date" id="appointment-date" class="input-enhanced w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-secondary mb-1">Appointment Time</label>
            <input type="time" id="appointment-time" class="input-enhanced w-full" required>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Doctor's Name</label>
          <input type="text" id="doctor-name" class="input-enhanced w-full" placeholder="Dr. Smith" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Specialty/Department</label>
          <select id="appointment-type" class="input-enhanced w-full" required>
            <option value="">Select specialty...</option>
            <option value="pediatrician">Pediatrician</option>
            <option value="family-medicine">Family Medicine</option>
            <option value="vaccination">Vaccination</option>
            <option value="wellness-check">Wellness Check</option>
            <option value="sick-visit">Sick Visit</option>
            <option value="follow-up">Follow-up</option>
            <option value="specialist">Specialist</option>
            <option value="emergency">Emergency</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Location/Clinic</label>
          <input type="text" id="appointment-location" class="input-enhanced w-full" placeholder="Children's Hospital, Room 205" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Reason for Visit</label>
          <textarea id="appointment-reason" class="input-enhanced w-full h-20 resize-none" placeholder="Describe the reason for the appointment..." required></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-secondary mb-1">Notes (optional)</label>
          <textarea id="appointment-notes" class="input-enhanced w-full h-20 resize-none" placeholder="Any additional notes, questions to ask, etc..."></textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-secondary mb-1">Reminder</label>
            <select id="appointment-reminder" class="input-enhanced w-full">
              <option value="none">No reminder</option>
              <option value="1-day">1 day before</option>
              <option value="2-hours">2 hours before</option>
              <option value="1-hour">1 hour before</option>
              <option value="30-min">30 minutes before</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-secondary mb-1">Status</label>
            <select id="appointment-status" class="input-enhanced w-full" required>
              <option value="scheduled">Scheduled</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">
          Add Appointment
        </button>
      </form>
    </div>
  </div>
  <!-- Appointment Details Modal -->
  <div id="appointment-details-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Appointment Details</h2>
        <button onclick="hideModal('appointment-details-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Appointment Info -->
        <div>
          <h3 class="font-semibold mb-4">Appointment Information</h3>
          <div id="appointment-details-content" class="space-y-4">
            <!-- Content will be populated by JavaScript -->
          </div>
        </div>
        <!-- Visit Summary -->
        <div>
          <h3 class="font-semibold mb-4">Visit Summary</h3>
          <div id="visit-summary-content" class="space-y-4">
            <div class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4">
              <h4 class="font-semibold text-primary mb-3">Add Visit Summary</h4>
              <form id="visit-summary-form" class="space-y-3">
                <input type="hidden" id="summary-appointment-id">
                <div>
                  <label class="block text-sm font-medium text-secondary mb-1">Diagnosis/Findings</label>
                  <textarea id="visit-diagnosis" class="input-enhanced w-full h-20 resize-none" placeholder="What did the doctor find?"></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium text-secondary mb-1">Treatment/Recommendations</label>
                  <textarea id="visit-treatment" class="input-enhanced w-full h-20 resize-none" placeholder="What treatment was prescribed?"></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium text-secondary mb-1">Medications</label>
                  <textarea id="visit-medications" class="input-enhanced w-full h-20 resize-none" placeholder="Any medications prescribed?"></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium text-secondary mb-1">Follow-up</label>
                  <textarea id="visit-followup" class="input-enhanced w-full h-20 resize-none" placeholder="When to follow up?"></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium text-secondary mb-1">Notes</label>
                  <textarea id="visit-notes" class="input-enhanced w-full h-20 resize-none" placeholder="Additional notes..."></textarea>
                </div>
                <div class="flex space-x-3">
                  <button type="submit" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                    Save Summary
                  </button>
                  <button type="button" onclick="markAppointmentComplete()" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                    Mark Complete
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Diaper Modal -->
  <div id="diaper-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass text-primary p-6 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold">Diaper Change</h2>
        <button onclick="hideModal('diaper-modal')" class="text-secondary hover:text-primary"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="space-y-4">
        <div class="text-center mb-6">
          <i class="fas fa-baby text-4xl text-amber-500 mb-2"></i>
          <p class="text-secondary">Select the type of diaper change:</p>
        </div>
        <button onclick="quickLogDiaper('wet-diaper')" class="w-full bg-blue-500 text-white font-bold py-4 px-6 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center space-x-3">
          <i class="fas fa-tint text-xl"></i>
          <span class="text-lg">Wet Diaper</span>
        </button>
        <button onclick="quickLogDiaper('dirty-diaper')" class="w-full bg-amber-500 text-white font-bold py-4 px-6 rounded-lg hover:bg-amber-600 transition-colors flex items-center justify-center space-x-3">
          <i class="fas fa-poop text-xl"></i>
          <span class="text-lg">Dirty Diaper</span>
        </button>
        <button onclick="quickLogDiaper('wet-dirty-diaper')" class="w-full bg-orange-500 text-white font-bold py-4 px-6 rounded-lg hover:bg-orange-600 transition-colors flex items-center justify-center space-x-3">
          <i class="fas fa-baby text-xl"></i>
          <span class="text-lg">Wet & Dirty</span>
        </button>
      </div>
    </div>
  </div>
  <script>
    // --- GLOBAL STATE ---
    let customActivities = [];
    let activityLog = [];
    let moodAnalytics = { total: 0, moods: {} };
    let milestones = [];
    let growthData = [];
    let feedingSchedules = [];
    let reminders = [];
    let appointments = [];
    let inventory = {
      diapers: 0,
      wipes: 0,
      formula: 0,
      medicine: 0
    };
    let timerState = {
      isRunning: false,
      startTime: null,
      currentActivity: null,
      interval: null,
      elapsed: 0
    };
    const defaultActivities = [
      { id: 'feed', name: 'Feed', icon: 'fas fa-utensils', color: 'blue-500' },
      { id: 'sleep', name: 'Sleep', icon: 'fas fa-moon', color: 'indigo-500' },
      { id: 'nap', name: 'Nap', icon: 'fas fa-bed', color: 'purple-500' },
      { id: 'diaper', name: 'Diaper', icon: 'fas fa-baby', color: 'amber-500' },
      { id: 'tummy', name: 'Tummy Time', icon: 'fas fa-child-reaching', color: 'lime-500' },
      { id: 'mood', name: 'Mood', icon: 'fas fa-heart', color: 'pink-500' },
      { id: 'feeding-schedule', name: 'Schedule', icon: 'fas fa-clock', color: 'indigo-500' },
      { id: 'milestone', name: 'Milestone', icon: 'fas fa-trophy', color: 'yellow-500' },
      { id: 'medication', name: 'Meds', icon: 'fas fa-pills', color: 'cyan-500' },
      { id: 'temperature', name: 'Temp', icon: 'fas fa-thermometer', color: 'orange-500' },
      { id: 'vaccine', name: 'Vaccine', icon: 'fas fa-syringe', color: 'teal-500' },
    ];
    // --- PROFILE STATE ---
    let babyProfiles = [], currentProfileId = null;
    // --- DATA MANAGEMENT ---
    function saveData() {
      try {
        localStorage.setItem(`activityLog_${currentProfileId}`, JSON.stringify(activityLog));
        localStorage.setItem(`moodAnalytics_${currentProfileId}`, JSON.stringify(moodAnalytics));
        localStorage.setItem(`customActivities_${currentProfileId}`, JSON.stringify(customActivities));
        localStorage.setItem(`milestones_${currentProfileId}`, JSON.stringify(milestones));
        localStorage.setItem(`growthData_${currentProfileId}`, JSON.stringify(growthData));
        localStorage.setItem(`feedingSchedules_${currentProfileId}`, JSON.stringify(feedingSchedules));
        localStorage.setItem(`reminders_${currentProfileId}`, JSON.stringify(reminders));
        localStorage.setItem(`appointments_${currentProfileId}`, JSON.stringify(appointments));
        localStorage.setItem(`inventory_${currentProfileId}`, JSON.stringify(inventory));
      } catch (error) {
        console.error('Failed to save data:', error);
      }
    }
    function loadData() {
      try {
        activityLog = JSON.parse(localStorage.getItem(`activityLog_${currentProfileId}`) || '[]');
        moodAnalytics = JSON.parse(localStorage.getItem(`moodAnalytics_${currentProfileId}`) || '{"total": 0, "moods": {}}');
        customActivities = JSON.parse(localStorage.getItem(`customActivities_${currentProfileId}`) || '[]');
        milestones = JSON.parse(localStorage.getItem(`milestones_${currentProfileId}`) || '[]');
        growthData = JSON.parse(localStorage.getItem(`growthData_${currentProfileId}`) || '[]');
        feedingSchedules = JSON.parse(localStorage.getItem(`feedingSchedules_${currentProfileId}`) || '[]');
        reminders = JSON.parse(localStorage.getItem(`reminders_${currentProfileId}`) || '[]');
        appointments = JSON.parse(localStorage.getItem(`appointments_${currentProfileId}`) || '[]');
        inventory = JSON.parse(localStorage.getItem(`inventory_${currentProfileId}`) || '{"diapers": 0, "wipes": 0, "formula": 0, "medicine": 0}');
      } catch (error) {
        console.error('Failed to load data:', error);
        activityLog = [];
        moodAnalytics = { total: 0, moods: {} };
        customActivities = [];
        milestones = [];
        growthData = [];
        feedingSchedules = [];
        reminders = [];
        appointments = [];
        inventory = { diapers: 0, wipes: 0, formula: 0, medicine: 0 };
      }
    }
    // --- ACTIVITY LOGGING ---
    function addEntry(activityType, timestamp, notes = '', mood = null, quantity = null, feedType = null) {
      const entry = {
        id: Date.now().toString(),
        type: activityType,
        timestamp: timestamp,
        notes: notes,
        mood: mood,
        quantity: quantity,
        feedType: feedType
      };
      
      // Deduct inventory items based on activity type
      deductInventoryForActivity(activityType, quantity, feedType);
      
      activityLog.unshift(entry);
      if (mood) {
        moodAnalytics.total++;
        moodAnalytics.moods[mood] = (moodAnalytics.moods[mood] || 0) + 1;
      }
      saveData();
      renderActivityLog();
      renderMoodAnalytics();
      updateLastLogDisplay();
      
      // Update daily stats if the activity is from today
      const entryDate = new Date(timestamp);
      const today = new Date();
      if (entryDate.toDateString() === today.toDateString()) {
        updateDailyStats(today);
      }
    }
    
    // --- INVENTORY DEDUCTION FOR ACTIVITIES ---
    function deductInventoryForActivity(activityType, quantity = null, feedType = null) {
      let deductions = [];
      
      switch (activityType) {
        case 'wet-diaper':
        case 'dirty-diaper':
        case 'wet-dirty-diaper':
          // Diaper change uses 1 diaper and typically 2-3 wipes
          if (inventory.diapers > 0) {
            inventory.diapers--;
            deductions.push('1 diaper');
          }
          if (inventory.wipes >= 2) {
            inventory.wipes -= 2;
            deductions.push('2 wipes');
          } else if (inventory.wipes > 0) {
            const wipesUsed = inventory.wipes;
            inventory.wipes = 0;
            deductions.push(`${wipesUsed} wipe${wipesUsed > 1 ? 's' : ''}`);
          }
          break;
          
        case 'feed':
          // Formula feeding deducts formula based on quantity
          if (feedType === 'formula' && quantity && quantity > 0) {
            // Convert oz to formula bottles (assuming 1 bottle = 4 oz)
            const bottlesNeeded = Math.ceil(quantity / 4);
            if (inventory.formula >= bottlesNeeded) {
              inventory.formula -= bottlesNeeded;
              deductions.push(`${bottlesNeeded} formula bottle${bottlesNeeded > 1 ? 's' : ''}`);
            } else if (inventory.formula > 0) {
              const bottlesUsed = inventory.formula;
              inventory.formula = 0;
              deductions.push(`${bottlesUsed} formula bottle${bottlesUsed > 1 ? 's' : ''}`);
            }
          }
          break;
          
        case 'medication':
          // Medication uses 1 dose
          if (inventory.medicine > 0) {
            inventory.medicine--;
            deductions.push('1 medicine dose');
          }
          break;
      }
      
      // Show notification if items were deducted
      if (deductions.length > 0) {
        const message = `Used: ${deductions.join(', ')}`;
        showInventoryNotification(message);
      }
      
      // Show warning if any item is now low or out of stock
      checkLowStockWarnings();
      
      // Update inventory display
      renderInventory();
    }
    
    function restoreInventoryFromActivity(activityType, quantity = null, feedType = null) {
      let restorations = [];
      
      switch (activityType) {
        case 'wet-diaper':
        case 'dirty-diaper':
        case 'wet-dirty-diaper':
          // Restore 1 diaper and 2 wipes
          inventory.diapers++;
          inventory.wipes += 2;
          restorations.push('1 diaper, 2 wipes');
          break;
          
        case 'feed':
          // Restore formula if it was formula feeding
          if (feedType === 'formula' && quantity && quantity > 0) {
            const bottlesRestored = Math.ceil(quantity / 4);
            inventory.formula += bottlesRestored;
            restorations.push(`${bottlesRestored} formula bottle${bottlesRestored > 1 ? 's' : ''}`);
          }
          break;
          
        case 'medication':
          // Restore 1 medicine dose
          inventory.medicine++;
          restorations.push('1 medicine dose');
          break;
      }
      
      // Show notification if items were restored
      if (restorations.length > 0) {
        const message = `Restored: ${restorations.join(', ')}`;
        showInventoryNotification(message);
      }
      
      // Update inventory display
      renderInventory();
    }
    
    function showInventoryNotification(message) {
      // Create a temporary notification element
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 opacity-0 translate-x-full';
      notification.innerHTML = `
        <div class="flex items-center space-x-2">
          <i class="fas fa-boxes"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.classList.remove('opacity-0', 'translate-x-full');
      }, 100);
      
      // Animate out and remove after 3 seconds
      setTimeout(() => {
        notification.classList.add('opacity-0', 'translate-x-full');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
    
    function checkLowStockWarnings() {
      const lowStockThreshold = 5;
      const warnings = [];
      
      if (inventory.diapers <= lowStockThreshold && inventory.diapers > 0) {
        warnings.push(`Low on diapers: ${inventory.diapers} remaining`);
      } else if (inventory.diapers === 0) {
        warnings.push('Out of diapers!');
      }
      
      if (inventory.wipes <= lowStockThreshold && inventory.wipes > 0) {
        warnings.push(`Low on wipes: ${inventory.wipes} remaining`);
      } else if (inventory.wipes === 0) {
        warnings.push('Out of wipes!');
      }
      
      if (inventory.formula <= lowStockThreshold && inventory.formula > 0) {
        warnings.push(`Low on formula: ${inventory.formula} bottles remaining`);
      } else if (inventory.formula === 0) {
        warnings.push('Out of formula!');
      }
      
      if (inventory.medicine <= lowStockThreshold && inventory.medicine > 0) {
        warnings.push(`Low on medicine: ${inventory.medicine} doses remaining`);
      } else if (inventory.medicine === 0) {
        warnings.push('Out of medicine!');
      }
      
      // Show warnings if any
      if (warnings.length > 0) {
        const warningMessage = warnings.join('\n');
        showLowStockWarning(warningMessage);
      }
    }
    
    function showLowStockWarning(message) {
      // Create a temporary warning notification
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 left-4 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 opacity-0 -translate-x-full max-w-sm';
      notification.innerHTML = `
        <div class="flex items-center space-x-2">
          <i class="fas fa-exclamation-triangle"></i>
          <span class="text-sm">${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.classList.remove('opacity-0', '-translate-x-full');
      }, 100);
      
      // Animate out and remove after 5 seconds
      setTimeout(() => {
        notification.classList.add('opacity-0', '-translate-x-full');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 5000);
    }
    
    function renderActivityLog() {
      const container = $('#activity-log');
      if (!container) return;
      const recentEntries = activityLog.slice(0, 10);
      if (recentEntries.length === 0) {
        container.innerHTML = '<p class="text-secondary text-center py-4">No activities logged yet. Start tracking your baby\'s day!</p>';
        return;
      }
      container.innerHTML = recentEntries.map(entry => {
        const activity = [...defaultActivities, ...customActivities].find(a => a.id === entry.type);
        const timeAgo = getTimeAgo(new Date(entry.timestamp));
        const moodDisplay = entry.mood ? `<span class="text-2xl ml-2">${entry.mood}</span>` : '';
        const quantityDisplay = entry.quantity ? `<div class="text-sm text-blue-600 font-medium">${entry.quantity} oz</div>` : '';
        const feedTypeDisplay = entry.feedType ? `<div class="text-sm text-purple-600 font-medium">${entry.feedType === 'breast' ? 'Breast' : 'Formula'}</div>` : '';
        return `
          <div class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-800/50 rounded-lg">
            <div class="flex items-center">
              <i class="${activity?.icon || 'fas fa-question'} text-${activity?.color || 'gray-500'} text-xl mr-3"></i>
              <div>
                <div class="font-semibold text-primary">${activity?.name || entry.type}</div>
                <div class="text-sm text-secondary">${timeAgo}</div>
                ${feedTypeDisplay}
                ${quantityDisplay}
                ${entry.notes ? `<div class="text-sm text-secondary mt-1">${entry.notes}</div>` : ''}
              </div>
            </div>
            <div class="flex items-center space-x-2">
              ${moodDisplay}
              <button onclick="editActivity('${entry.id}')" class="text-blue-500 hover:text-blue-700 transition-colors" title="Edit activity">
                <i class="fas fa-edit"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      return `${diffDays}d ago`;
    }
    function updateLastLogDisplay() {
      const lastEntry = activityLog[0];
      if (lastEntry) {
        const activity = [...defaultActivities, ...customActivities].find(a => a.id === lastEntry.type);
        const timeAgo = getTimeAgo(new Date(lastEntry.timestamp));
        // You can add this to the header or a separate display area
      }
    }
    // --- MOOD ANALYTICS ---
    function renderMoodAnalytics() {
      const container = $('#mood-analytics');
      if (!container) return;
      
      if (moodAnalytics.total === 0) {
        container.innerHTML = '<p class="text-secondary">Log mood activities to see analytics here!</p>';
        return;
      }
      
      const moodEmojis = ['üò¢', 'üòê', 'üôÇ', 'üòä', 'üòÑ'];
      const moodNames = ['Very Sad', 'Sad', 'Neutral', 'Happy', 'Very Happy'];
      
      let html = '<div class="space-y-3">';
      moodEmojis.forEach((emoji, index) => {
        const count = moodAnalytics.moods[emoji] || 0;
        const percentage = moodAnalytics.total > 0 ? Math.round((count / moodAnalytics.total) * 100) : 0;
        const barWidth = percentage;
        
        html += `
          <div class="flex items-center space-x-3">
            <span class="text-2xl w-8">${emoji}</span>
            <div class="flex-1">
              <div class="flex justify-between text-sm mb-1">
                <span class="font-medium">${moodNames[index]}</span>
                <span class="text-secondary">${count} (${percentage}%)</span>
              </div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                <div class="bg-gradient-to-r from-blue-400 to-purple-500 h-2 rounded-full transition-all duration-500" style="width: ${barWidth}%"></div>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }
    // --- MILESTONE TRACKING ---
    function updateMilestoneTicker() {
      const ticker = $('#milestone-text');
      if (!ticker) return;
      
      if (milestones.length === 0) {
        ticker.textContent = 'No milestones recorded yet. Add your first milestone!';
        return;
      }
      
      // Get the most recent milestone
      const recentMilestone = milestones[0];
      const milestoneDate = new Date(recentMilestone.date);
      const daysAgo = Math.floor((new Date() - milestoneDate) / (1000 * 60 * 60 * 24));
      
      let milestoneText = '';
      if (recentMilestone.type === 'custom') {
        milestoneText = `${recentMilestone.customText} - ${daysAgo} day${daysAgo !== 1 ? 's' : ''} ago`;
      } else {
        const milestoneNames = {
          'first-smile': 'First Smile',
          'first-roll': 'First Roll',
          'first-sit': 'First Sit',
          'first-crawl': 'First Crawl',
          'first-step': 'First Step',
          'first-word': 'First Word',
          'first-tooth': 'First Tooth'
        };
        milestoneText = `${milestoneNames[recentMilestone.type] || recentMilestone.type} - ${daysAgo} day${daysAgo !== 1 ? 's' : ''} ago`;
      }
      
      ticker.textContent = milestoneText;
    }
    function addMilestone(type, date, notes = '', customText = '') {
      const milestone = {
        id: Date.now().toString(),
        type: type,
        date: date,
        notes: notes,
        customText: customText,
        timestamp: new Date().toISOString()
      };
      milestones.unshift(milestone);
      saveData();
      updateMilestoneTicker();
    }
    // --- GROWTH TRACKING ---
    function addGrowthMeasurement(type, value, unit, date) {
      type = type.toLowerCase(); // Ensure type is lowercase for consistency
      console.log('Adding growth measurement:', { type, value, unit, date });
      const measurement = {
        id: Date.now().toString(),
        type: type,
        value: parseFloat(value),
        unit: unit,
        date: date,
        timestamp: new Date().toISOString()
      };
      growthData.push(measurement);
      growthData.sort((a, b) => new Date(b.date) - new Date(a.date));
      saveData();
      renderGrowthHistory();

      // Log as activity for weight/height
      if (type === 'weight' || type === 'height') {
        let displayValue = value;
        if (unit === 'ft-in') {
          const totalInches = value;
          const feet = Math.floor(totalInches / 12);
          const inches = Math.round(totalInches % 12);
          displayValue = `${feet}-${inches}`;
        } else if (unit === 'm-cm') {
          const totalCm = value;
          const meters = Math.floor(totalCm / 100);
          const centimeters = Math.round(totalCm % 100);
          displayValue = `${meters}-${centimeters}`;
        } else {
          displayValue = Math.round(value * 10) / 10;
        }
        const note = `Logged ${type.charAt(0).toUpperCase() + type.slice(1)}: ${displayValue} ${unit}`;
        addEntry(type, new Date().toISOString(), note);
      }
      // Update header stats
      updateHeaderStats();
    }
    
    function updateMeasurementFields() {
      const typeSelect = document.getElementById('measurement-type');
      const unitSelect = document.getElementById('measurement-unit');
      const valueLabel = document.getElementById('value-label');
      const formatHint = document.getElementById('format-hint');
      const valueInput = document.getElementById('measurement-value');
      const inputHelp = document.getElementById('input-help');
      
      const type = typeSelect.value;
      const unit = unitSelect.value;
      
      // Reset fields
      valueInput.value = '';
      valueInput.placeholder = '';
      formatHint.textContent = '';
      inputHelp.textContent = '';
      
      if (!type || !unit) {
        valueLabel.textContent = 'Value';
        return;
      }
      
      // Update unit options based on measurement type
      const unitOptions = unitSelect.querySelectorAll('option');
      unitOptions.forEach(option => {
        if (option.value === '') return; // Skip the placeholder
        
        const dataType = option.getAttribute('data-type');
        if (dataType) {
          const allowedTypes = dataType.split(',');
          if (allowedTypes.includes(type)) {
            option.style.display = '';
          } else {
            option.style.display = 'none';
          }
        }
      });
      
      // Update labels and hints based on type and unit
      if (type === 'weight') {
        valueLabel.textContent = 'Weight';
        if (unit === 'lbs') {
          valueInput.placeholder = 'e.g., 8.5';
          formatHint.textContent = '(pounds)';
          inputHelp.textContent = 'Enter weight in pounds (e.g., 8.5 for 8 pounds 8 ounces)';
        } else if (unit === 'kg') {
          valueInput.placeholder = 'e.g., 3.9';
          formatHint.textContent = '(kilograms)';
          inputHelp.textContent = 'Enter weight in kilograms (e.g., 3.9 for 3.9 kg)';
        }
      } else if (type === 'height') {
        valueLabel.textContent = 'Height';
        if (unit === 'in') {
          valueInput.placeholder = 'e.g., 20.5';
          formatHint.textContent = '(inches)';
          inputHelp.textContent = 'Enter height in inches (e.g., 20.5 for 20.5 inches)';
        } else if (unit === 'cm') {
          valueInput.placeholder = 'e.g., 52.1';
          formatHint.textContent = '(centimeters)';
          inputHelp.textContent = 'Enter height in centimeters (e.g., 52.1 for 52.1 cm)';
        } else if (unit === 'ft-in') {
          valueInput.placeholder = 'e.g., 1-8';
          formatHint.textContent = '(feet-inches)';
          inputHelp.textContent = 'Enter height as feet-inches (e.g., 1-8 for 1 foot 8 inches)';
        } else if (unit === 'm-cm') {
          valueInput.placeholder = 'e.g., 0-52';
          formatHint.textContent = '(meters-centimeters)';
          inputHelp.textContent = 'Enter height as meters-centimeters (e.g., 0-52 for 0 meters 52 cm)';
        }
      } else if (type === 'head-circumference') {
        valueLabel.textContent = 'Head Circumference';
        if (unit === 'in') {
          valueInput.placeholder = 'e.g., 14.2';
          formatHint.textContent = '(inches)';
          inputHelp.textContent = 'Enter head circumference in inches (e.g., 14.2 for 14.2 inches)';
        } else if (unit === 'cm') {
          valueInput.placeholder = 'e.g., 36.1';
          formatHint.textContent = '(centimeters)';
          inputHelp.textContent = 'Enter head circumference in centimeters (e.g., 36.1 for 36.1 cm)';
        }
      }
    }
    
    function validateMeasurementValue(value, type, unit) {
      if (!value || !type || !unit) return false;
      
      // Remove extra spaces
      value = value.trim();
      
      if (type === 'weight') {
        if (unit === 'lbs' || unit === 'kg') {
          const numValue = parseFloat(value);
          return !isNaN(numValue) && numValue > 0 && numValue < 1000;
        }
      } else if (type === 'height') {
        if (unit === 'in' || unit === 'cm') {
          const numValue = parseFloat(value);
          return !isNaN(numValue) && numValue > 0 && numValue < 200;
        } else if (unit === 'ft-in') {
          // Format: feet-inches (e.g., 1-8, 2-3)
          const match = value.match(/^(\d+)-(\d+)$/);
          if (!match) return false;
          const feet = parseInt(match[1]);
          const inches = parseInt(match[2]);
          return feet >= 0 && feet < 10 && inches >= 0 && inches < 12;
        } else if (unit === 'm-cm') {
          // Format: meters-centimeters (e.g., 0-52, 1-25)
          const match = value.match(/^(\d+)-(\d+)$/);
          if (!match) return false;
          const meters = parseInt(match[1]);
          const centimeters = parseInt(match[2]);
          return meters >= 0 && meters < 3 && centimeters >= 0 && centimeters < 100;
        }
      } else if (type === 'head-circumference') {
        if (unit === 'in' || unit === 'cm') {
          const numValue = parseFloat(value);
          return !isNaN(numValue) && numValue > 0 && numValue < 100;
        }
      }
      
      return false;
    }
    
    function parseMeasurementValue(value, type, unit) {
      if (!value || !type || !unit) return null;
      
      value = value.trim();
      
      if (type === 'weight') {
        if (unit === 'lbs' || unit === 'kg') {
          return parseFloat(value);
        }
      } else if (type === 'height') {
        if (unit === 'in' || unit === 'cm') {
          return parseFloat(value);
        } else if (unit === 'ft-in') {
          // Convert feet-inches to total inches
          const match = value.match(/^(\d+)-(\d+)$/);
          if (match) {
            const feet = parseInt(match[1]);
            const inches = parseInt(match[2]);
            return feet * 12 + inches;
          }
        } else if (unit === 'm-cm') {
          // Convert meters-centimeters to total centimeters
          const match = value.match(/^(\d+)-(\d+)$/);
          if (match) {
            const meters = parseInt(match[1]);
            const centimeters = parseInt(match[2]);
            return meters * 100 + centimeters;
          }
        }
      } else if (type === 'head-circumference') {
        if (unit === 'in' || unit === 'cm') {
          return parseFloat(value);
        }
      }
      
      return null;
    }
    function renderGrowthHistory() {
      const container = $('#growth-history');
      if (!container) return;
      
      if (growthData.length === 0) {
        container.innerHTML = '<p class="text-secondary text-center py-4">No measurements recorded yet.</p>';
        return;
      }
      
      const recentMeasurements = growthData.slice(0, 10);
      container.innerHTML = recentMeasurements.map(measurement => {
        const measurementNames = {
          'weight': 'Weight',
          'height': 'Height',
          'head-circumference': 'Head Circumference'
        };
        
        // Format the display value based on unit
        let displayValue = measurement.value;
        let displayUnit = measurement.unit;
        
        if (measurement.unit === 'ft-in') {
          // Convert total inches back to feet-inches format
          const totalInches = measurement.value;
          const feet = Math.floor(totalInches / 12);
          const inches = Math.round(totalInches % 12);
          displayValue = `${feet}-${inches}`;
          displayUnit = 'ft-in';
        } else if (measurement.unit === 'm-cm') {
          // Convert total centimeters back to meters-centimeters format
          const totalCm = measurement.value;
          const meters = Math.floor(totalCm / 100);
          const centimeters = Math.round(totalCm % 100);
          displayValue = `${meters}-${centimeters}`;
          displayUnit = 'm-cm';
        } else {
          // For other units, round to 1 decimal place
          displayValue = Math.round(measurement.value * 10) / 10;
        }
        
        return `
          <div class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-800/50 rounded-lg">
            <div class="flex items-center">
              <i class="fas fa-chart-line text-blue-500 text-xl mr-3"></i>
              <div>
                <div class="font-semibold text-primary">${measurementNames[measurement.type]}</div>
                <div class="text-sm text-secondary">${displayValue} ${displayUnit}</div>
              </div>
            </div>
            <div class="text-sm text-secondary">${new Date(measurement.date).toLocaleDateString()}</div>
          </div>
        `;
      }).join('');
      
      // Auto-show weight chart if available
      const weightData = growthData.filter(m => m.type === 'weight');
      if (weightData.length > 0) {
        showGrowthChart('weight');
      }
    }
    // --- TOT REPORT ---
    function generateTotReport() {
      const reportDate = document.getElementById('report-date').value;
      if (!reportDate) return;
      
      const container = $('#tot-report-content');
      if (!container) return;
      
      const selectedDate = new Date(reportDate);
      const startOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
      const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);
      
      // Filter activities for the selected date
      const dayActivities = activityLog.filter(entry => {
        const entryDate = new Date(entry.timestamp);
        return entryDate >= startOfDay && entryDate < endOfDay;
      });
      
      if (dayActivities.length === 0) {
        container.innerHTML = '<p class="text-secondary text-center py-8">No activities recorded for this date.</p>';
        return;
      }
      
      // Group activities by type
      const activityCounts = {};
      const moodEntries = [];
      const feedTimes = [];
      const feedQuantities = [];
      const wetDiaperCount = dayActivities.filter(e => e.type === 'wet-diaper').length;
      const dirtyDiaperCount = dayActivities.filter(e => e.type === 'dirty-diaper').length;
      const wetDirtyDiaperCount = dayActivities.filter(e => e.type === 'wet-dirty-diaper').length;
      const diaperCount = wetDiaperCount + dirtyDiaperCount + wetDirtyDiaperCount;
      const diaperTimes = [];
      const sleepTimes = [];
      dayActivities.forEach(entry => {
        const activity = [...defaultActivities, ...customActivities].find(a => a.id === entry.type);
        const activityName = activity ? activity.name : entry.type;
        activityCounts[activityName] = (activityCounts[activityName] || 0) + 1;
        if (entry.mood) {
          moodEntries.push(entry.mood);
        }
        // Track specific activity times for detailed analysis
        if (entry.type === 'feed') {
          feedTimes.push(new Date(entry.timestamp));
          if (entry.quantity) {
            feedQuantities.push(entry.quantity);
          }
        } else if (['wet-diaper','dirty-diaper','wet-dirty-diaper'].includes(entry.type)) {
          diaperTimes.push(new Date(entry.timestamp));
        } else if (entry.type === 'sleep' || entry.type === 'nap') {
          sleepTimes.push(new Date(entry.timestamp));
        }
      });
      
      let html = `
        <div class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4">
          <h3 class="font-bold text-lg mb-4">Daily Summary for ${selectedDate.toLocaleDateString()}</h3>
          <div class="space-y-4">
      `;
      
      // Activity summary
      html += '<div><h4 class="font-semibold text-primary mb-2">Activities:</h4>';
      Object.entries(activityCounts).forEach(([activity, count]) => {
        html += `<div class="flex justify-between text-sm"><span>${activity}</span><span class="font-medium">${count}</span></div>`;
      });
      html += '</div>';
      
      // Feeding analysis
      if (feedTimes.length > 0) {
        html += '<div><h4 class="font-semibold text-primary mb-2">Feeding Analysis:</h4>';
        html += `<div class="text-sm">Total feeds: ${feedTimes.length}</div>`;
        
        // Add quantity analysis
        if (feedQuantities.length > 0) {
          const totalQuantity = feedQuantities.reduce((sum, qty) => sum + qty, 0);
          const avgQuantity = Math.round((totalQuantity / feedQuantities.length) * 10) / 10;
          html += `<div class="text-sm">Total intake: ${totalQuantity} oz</div>`;
          html += `<div class="text-sm">Average per feed: ${avgQuantity} oz</div>`;
        }
        
        if (feedTimes.length > 1) {
          const intervals = [];
          for (let i = 1; i < feedTimes.length; i++) {
            const interval = (feedTimes[i] - feedTimes[i-1]) / (1000 * 60); // minutes
            intervals.push(interval);
          }
          const avgInterval = Math.round(intervals.reduce((a, b) => a + b, 0) / intervals.length);
          html += `<div class="text-sm">Average interval: ${avgInterval} minutes</div>`;
        }
        
        const lastFeed = feedTimes[feedTimes.length - 1];
        const timeSinceLastFeed = Math.round((new Date() - lastFeed) / (1000 * 60));
        html += `<div class="text-sm">Time since last feed: ${timeSinceLastFeed} minutes</div>`;
        html += '</div>';
      }
      
      // Diaper analysis
      if (diaperTimes.length > 0) {
        html += '<div><h4 class="font-semibold text-primary mb-2">Diaper Analysis:</h4>';
        html += `<div class="text-sm">Total changes: ${diaperTimes.length}</div>`;
        
        const lastDiaper = diaperTimes[diaperTimes.length - 1];
        const timeSinceLastDiaper = Math.round((new Date() - lastDiaper) / (1000 * 60));
        html += `<div class="text-sm">Time since last change: ${timeSinceLastDiaper} minutes</div>`;
        html += '</div>';
      }
      
      // Sleep analysis
      if (sleepTimes.length > 0) {
        html += '<div><h4 class="font-semibold text-primary mb-2">Sleep Analysis:</h4>';
        html += `<div class="text-sm">Total sleep sessions: ${sleepTimes.length}</div>`;
        html += '</div>';
      }
      
      // Mood summary
      if (moodEntries.length > 0) {
        const moodCounts = {};
        moodEntries.forEach(mood => {
          moodCounts[mood] = (moodCounts[mood] || 0) + 1;
        });
        
        html += '<div><h4 class="font-semibold text-primary mb-2">Mood Summary:</h4>';
        Object.entries(moodCounts).forEach(([mood, count]) => {
          html += `<div class="flex justify-between text-sm"><span>${mood}</span><span class="font-medium">${count}</span></div>`;
        });
        html += '</div>';
      }
      
      html += '</div></div>';
      container.innerHTML = html;
      
      // Update daily stats panel
      updateDailyStats(selectedDate);
    }
    
    function updateDailyStats(selectedDate) {
      const startOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
      const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);
      
      // Filter activities for the selected date
      const dayActivities = activityLog.filter(entry => {
        const entryDate = new Date(entry.timestamp);
        return entryDate >= startOfDay && entryDate < endOfDay;
      });
      
      // Feeding stats
      const feedActivities = dayActivities.filter(entry => entry.type === 'feed');
      const feedTimes = feedActivities.map(entry => new Date(entry.timestamp));
      
      document.getElementById('stats-feeds').textContent = feedActivities.length;
      
      // Calculate total feed quantity
      const totalQuantity = feedActivities.reduce((sum, entry) => {
        return sum + (entry.quantity || 0);
      }, 0);
      document.getElementById('stats-feed-quantity').textContent = `${totalQuantity} oz`;
      
      if (feedTimes.length > 0) {
        const lastFeed = feedTimes[feedTimes.length - 1];
        const timeSinceLastFeed = Math.round((new Date() - lastFeed) / (1000 * 60));
        document.getElementById('stats-last-feed').textContent = `${timeSinceLastFeed}m ago`;
        
        if (feedTimes.length > 1) {
          const intervals = [];
          for (let i = 1; i < feedTimes.length; i++) {
            const interval = (feedTimes[i] - feedTimes[i-1]) / (1000 * 60);
            intervals.push(interval);
          }
          const avgInterval = Math.round(intervals.reduce((a, b) => a + b, 0) / intervals.length);
          document.getElementById('stats-feed-interval').textContent = `${avgInterval}m`;
        } else {
          document.getElementById('stats-feed-interval').textContent = '-';
        }
      } else {
        document.getElementById('stats-last-feed').textContent = '-';
        document.getElementById('stats-feed-interval').textContent = '-';
      }
      
      // Diaper stats
      const wetDiaperActivities = dayActivities.filter(entry => entry.type === 'wet-diaper');
      const dirtyDiaperActivities = dayActivities.filter(entry => entry.type === 'dirty-diaper');
      const wetDirtyDiaperActivities = dayActivities.filter(entry => entry.type === 'wet-dirty-diaper');
      const diaperActivities = [...wetDiaperActivities, ...dirtyDiaperActivities, ...wetDirtyDiaperActivities];
      const diaperTimes = diaperActivities.map(entry => new Date(entry.timestamp));
      document.getElementById('stats-diapers').textContent = diaperActivities.length;
      if (diaperTimes.length > 0) {
        const lastDiaper = diaperTimes[diaperTimes.length - 1];
        const timeSinceLastDiaper = Math.round((new Date() - lastDiaper) / (1000 * 60));
        document.getElementById('stats-last-diaper').textContent = `${timeSinceLastDiaper}m ago`;
      } else {
        document.getElementById('stats-last-diaper').textContent = '-';
      }
      document.getElementById('stats-wet-diapers').textContent = wetDiaperActivities.length;
      document.getElementById('stats-dirty-diapers').textContent = dirtyDiaperActivities.length;
      document.getElementById('stats-wet-dirty-diapers').textContent = wetDirtyDiaperActivities.length;
      
      // Sleep stats
      const sleepActivities = dayActivities.filter(entry => entry.type === 'sleep' || entry.type === 'nap');
      const napActivities = dayActivities.filter(entry => entry.type === 'nap');
      
      document.getElementById('stats-naps').textContent = napActivities.length;
      
      // Calculate total sleep time (this is simplified - could be enhanced with duration tracking)
      const totalSleepHours = sleepActivities.length * 2; // Estimate 2 hours per sleep session
      document.getElementById('stats-sleep-time').textContent = `${totalSleepHours}h`;
      
      if (napActivities.length > 0) {
        document.getElementById('stats-avg-nap').textContent = '2h'; // Estimate
      } else {
        document.getElementById('stats-avg-nap').textContent = '-';
      }
      
      // Inventory stats
      document.getElementById('stats-diapers-left').textContent = inventory.diapers;
      document.getElementById('stats-wipes-left').textContent = inventory.wipes;
      document.getElementById('stats-formula-left').textContent = inventory.formula;
    }
    // --- TIMER FUNCTIONALITY ---
    function selectTimerActivity(activityType) {
      if (timerState.isRunning) {
        alert('Please stop the current timer before selecting a new activity.');
        return;
      }
      
      timerState.currentActivity = activityType;
      
      // Update UI to show selected activity
      document.querySelectorAll('.timer-activity-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'bg-blue-100');
      });
      
      const selectedBtn = document.querySelector(`[onclick="selectTimerActivity('${activityType}')"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('border-blue-500', 'bg-blue-100');
      }
      
      // Update status
      const activityNames = {
        'sleep': 'Sleep',
        'nap': 'Nap',
        'tummy': 'Tummy Time'
      };
      document.getElementById('timer-status').textContent = `Ready to start: ${activityNames[activityType]}`;
      document.getElementById('timer-activity').textContent = `Activity: ${activityNames[activityType]}`;
    }
    
    function startTimer() {
      if (!timerState.currentActivity) {
        alert('Please select an activity first.');
        return;
      }
      
      if (timerState.isRunning) {
        alert('Timer is already running.');
        return;
      }
      
      timerState.isRunning = true;
      timerState.startTime = new Date();
      timerState.elapsed = 0;
      
      // Update UI
      document.getElementById('start-timer-btn').classList.add('hidden');
      document.getElementById('stop-timer-btn').classList.remove('hidden');
      document.getElementById('timer-display').classList.remove('hidden');
      document.getElementById('timer-selection').classList.add('hidden');
      
      const activityNames = {
        'sleep': 'Sleep',
        'nap': 'Nap',
        'tummy': 'Tummy Time'
      };
      document.getElementById('timer-status').textContent = `Timing: ${activityNames[timerState.currentActivity]}`;
      
      // Start the timer interval
      timerState.interval = setInterval(updateTimerDisplay, 1000);
    }
    
    function stopTimer() {
      if (!timerState.isRunning) {
        alert('No timer is running.');
        return;
      }
      
      // Stop the timer
      clearInterval(timerState.interval);
      timerState.isRunning = false;
      
      // Calculate duration
      const endTime = new Date();
      const duration = Math.floor((endTime - timerState.startTime) / 1000);
      
      // Log the activity
      const activityNames = {
        'sleep': 'Sleep',
        'nap': 'Nap',
        'tummy': 'Tummy Time'
      };
      
      const notes = `Duration: ${formatDuration(duration)}`;
      addEntry(timerState.currentActivity, timerState.startTime.toISOString(), notes);
      
      // Reset UI
      document.getElementById('start-timer-btn').classList.remove('hidden');
      document.getElementById('stop-timer-btn').classList.add('hidden');
      document.getElementById('timer-display').classList.add('hidden');
      document.getElementById('timer-selection').classList.remove('hidden');
      
      // Clear selection
      document.querySelectorAll('.timer-activity-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'bg-blue-100');
      });
      
      document.getElementById('timer-status').textContent = 'No active timer';
      timerState.currentActivity = null;
      timerState.startTime = null;
      timerState.interval = null;
      timerState.elapsed = 0;
    }
    
    function updateTimerDisplay() {
      if (!timerState.isRunning || !timerState.startTime) return;
      
      const now = new Date();
      const elapsed = Math.floor((now - timerState.startTime) / 1000);
      timerState.elapsed = elapsed;
      
      document.getElementById('timer-time').textContent = formatDuration(elapsed);
    }
    
    function formatDuration(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    function startQuickTimer(activityType, durationMinutes) {
      if (timerState.isRunning) {
        alert('Please stop the current timer first.');
        return;
      }
      
      timerState.currentActivity = activityType;
      timerState.isRunning = true;
      timerState.startTime = new Date();
      timerState.elapsed = 0;
      
      // Set up countdown timer
      const targetTime = new Date(timerState.startTime.getTime() + (durationMinutes * 60 * 1000));
      timerState.targetTime = targetTime;
      
      // Update UI
      document.getElementById('start-timer-btn').classList.add('hidden');
      document.getElementById('stop-timer-btn').classList.remove('hidden');
      document.getElementById('timer-display').classList.remove('hidden');
      document.getElementById('timer-selection').classList.add('hidden');
      
      const activityNames = {
        'sleep': 'Sleep',
        'nap': 'Nap',
        'tummy': 'Tummy Time'
      };
      document.getElementById('timer-status').textContent = `Timing: ${activityNames[activityType]} (${durationMinutes} min)`;
      document.getElementById('timer-activity').textContent = `Activity: ${activityNames[activityType]}`;
      
      // Start the timer interval
      timerState.interval = setInterval(() => {
        updateCountdownTimer();
      }, 1000);
      
      hideModal('timer-settings-modal');
    }
    
    function updateCountdownTimer() {
      if (!timerState.isRunning || !timerState.targetTime) return;
      
      const now = new Date();
      const remaining = Math.max(0, Math.floor((timerState.targetTime - now) / 1000));
      
      if (remaining <= 0) {
        // Timer finished
        stopTimer();
        showTimerCompleteNotification();
        return;
      }
      
      document.getElementById('timer-time').textContent = formatDuration(remaining);
    }
    
    function showTimerCompleteNotification() {
      const activityNames = {
        'sleep': 'Sleep',
        'nap': 'Nap',
        'tummy': 'Tummy Time'
      };
      
      const activityName = activityNames[timerState.currentActivity] || 'Activity';
      
      // Create notification
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50 animate-bounce';
      notification.innerHTML = `
        <div class="flex items-center space-x-3">
          <i class="fas fa-bell text-2xl"></i>
          <div>
            <div class="font-bold">Timer Complete!</div>
            <div class="text-sm">${activityName} session finished</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Remove notification after 5 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 5000);
    }
    // --- BACKUP & RESTORE ---
    function exportData() {
      const data = {
        profiles: babyProfiles,
        currentProfileId: currentProfileId,
        activityLog: activityLog,
        moodAnalytics: moodAnalytics,
        customActivities: customActivities,
        milestones: milestones,
        growthData: growthData,
        feedingSchedules: feedingSchedules,
        reminders: reminders,
        appointments: appointments,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `littlesprout-backup-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert('Data exported successfully!');
    }
    function importData(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (data.profiles && data.activityLog !== undefined) {
            babyProfiles = data.profiles || [];
            currentProfileId = data.currentProfileId;
            activityLog = data.activityLog || [];
            moodAnalytics = data.moodAnalytics || { total: 0, moods: {} };
            customActivities = data.customActivities || [];
            milestones = data.milestones || [];
            growthData = data.growthData || [];
            feedingSchedules = data.feedingSchedules || [];
            reminders = data.reminders || [];
            appointments = data.appointments || [];
            
            saveProfiles();
            saveData();
            initializeApp();
            
            alert('Data imported successfully!');
            hideModal('backup-modal');
          } else {
            alert('Invalid backup file format.');
          }
        } catch (error) {
          console.error('Import error:', error);
          alert('Error importing data. Please check the file format.');
        }
      };
      reader.readAsText(file);
    }
    // --- DOM HELPERS ---
    const $ = (sel, p = document) => p.querySelector(sel);
    // --- ACTIVITY CAROUSEL ---
    function renderActivityButtons() {
      const container = $('#main-activity-buttons');
      const allActivities = [...defaultActivities, ...customActivities];
      if (!container) return;
      let html = '<div class="flex space-x-4 px-2 overflow-x-auto">';
      allActivities.forEach(act => {
        html += `<button onclick="quickLogActivity('${act.id}')" class="flex-shrink-0 flex flex-col items-center justify-center h-20 w-20 input-enhanced rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700/50 transition-all duration-300 transform hover:scale-105 focus-visible">
          <i class="${act.icon} text-${act.color} text-2xl mb-1"></i>
          <span class="font-semibold text-xs text-center">${act.name}</span>
        </button>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }
    function quickLogActivity(activityType) {
      if (activityType === 'diaper') {
        showModal('diaper-modal');
        return;
      }
      
      const now = new Date();
      const timestamp = now.toISOString().slice(0, 16); // Format for datetime-local input
      document.getElementById('activity-type').value = activityType;
      document.getElementById('activity-time').value = timestamp;
      document.getElementById('activity-notes').value = '';
      
      // Show quantity section if it's a feed activity
      const quantitySection = document.getElementById('feed-quantity-section');
      if (activityType === 'feed') {
        quantitySection.classList.remove('hidden');
        document.getElementById('feed-type').value = '';
        document.getElementById('feed-quantity').value = '';
      } else {
        quantitySection.classList.add('hidden');
      }
      
      // Show mood section if it's a mood activity
      const moodSection = document.getElementById('mood-section');
      if (activityType === 'mood') {
        moodSection.classList.remove('hidden');
      } else {
        moodSection.classList.add('hidden');
      }
      
      showModal('log-modal');
    }
    // --- CLOCK & WEATHER ---
    function startDateTime() {
      const mainTimeEl = $('#main-time-display'), mainAmpmEl = $('#main-ampm-display'), mainDateEl = $('#main-date-display');
      setInterval(() => {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
        mainTimeEl.textContent = timeString.slice(0, -3);
        mainAmpmEl.textContent = timeString.slice(-2);
        mainDateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      }, 1000);
    }
    async function fetchWeather(lat = 28.11, lon = -81.62) {
      const mainWeather = $('#main-weather-display');
      if (!mainWeather) return;
      mainWeather.innerHTML = `<div class="flex items-center justify-center md:justify-end"><i class="fas fa-spinner fa-spin text-blue-400 mr-2"></i><span class="text-xs">Loading weather...</span></div>`;
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&temperature_unit=fahrenheit`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Weather service not available');
        const data = await res.json();
        const temp = Math.round(data.current.temperature_2m);
        const desc = getWeatherDescription(data.current.weather_code);
        const { icon, color } = getWeatherIconClass(data.current.weather_code);
        mainWeather.innerHTML = `<div class="flex items-center justify-center md:justify-end flex-wrap gap-2">
          <i class="fas ${icon} text-3xl ${color}"></i>
          <div class="weather-info text-center md:text-right overflow-hidden">
            <p class="weather-temp font-bold text-xl leading-none">${temp}¬∞F</p>
            <p class="weather-desc text-sm leading-tight">${desc}</p>
          </div>
        </div>`;
      } catch {
        mainWeather.innerHTML = `<div class="flex items-center justify-center md:justify-end"><i class="fas fa-exclamation-triangle text-orange-400 mr-2"></i><span class="text-xs">Weather unavailable</span></div>`;
      }
    }
    function getWeatherDescription(code) {
      const codes = {0:"Clear Sky",1:"Mainly Clear",2:"Partly Cloudy",3:"Overcast",45:"Fog",48:"Rime Fog",51:"Light Drizzle",53:"Drizzle",55:"Dense Drizzle",61:"Slight Rain",63:"Rain",65:"Heavy Rain",80:"Showers",81:"Showers",82:"Heavy Showers",95:"Thunderstorm"};
      return codes[code] || "Unknown";
    }
    function getWeatherIconClass(code) {
      if (code === 0) return { icon: 'fa-sun', color: 'text-yellow-400' };
      if (code >= 1 && code <= 3) return { icon: 'fa-cloud-sun', color: 'text-gray-400' };
      if (code === 45 || code === 48) return { icon: 'fa-smog', color: 'text-gray-500' };
      if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) return { icon: 'fa-cloud-showers-heavy', color: 'text-blue-400' };
      if (code >= 95 && code <= 99) return { icon: 'fa-bolt', color: 'text-yellow-500' };
      return { icon: 'fa-question-circle', color: 'text-gray-400' };
    }
    // --- THEME TOGGLE ---
    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark);
      const btn = document.querySelector('button[onclick="toggleDarkMode()"] i');
      if (btn) {
        btn.className = isDark ? 'fas fa-sun text-yellow-500 text-2xl' : 'fas fa-moon text-indigo-500 text-2xl';
      }
    }
    // --- MODAL HELPERS ---
    function showModal(id) {
      const modal = document.getElementById(id);
      if (modal) {
        modal.classList.remove('opacity-0', 'pointer-events-none');
      }
    }
    function hideModal(id) {
      const modal = document.getElementById(id);
      if (modal) {
        modal.classList.add('opacity-0', 'pointer-events-none');
      }
    }
    // --- ONBOARDING LOGIC ---
    function saveBabyInfo() {
      const userName = document.getElementById('user-name').value.trim();
      const babyName = document.getElementById('baby-name').value.trim();
      const dob = document.getElementById('baby-dob').value;
      if (!userName || !babyName || !dob) {
        alert('Please fill in all fields.');
        return;
      }
      const newProfile = { id: Date.now().toString(), userName, babyName, dob };
      babyProfiles.push(newProfile);
      currentProfileId = newProfile.id;
      saveProfiles();
      hideModal('setup-modal');
      initializeApp();
    }
    function showSetupForNewProfile() {
      document.getElementById('setup-title').textContent = 'Add New Profile';
      document.getElementById('setup-subtitle').textContent = 'Enter the details for the new baby.';
      document.getElementById('user-name').value = '';
      document.getElementById('baby-name').value = '';
      document.getElementById('baby-dob').value = '';
      showModal('setup-modal');
      hideModal('profile-modal');
    }
    function switchProfile() {
      currentProfileId = document.getElementById('profile-switcher').value;
      saveProfiles();
      initializeApp();
      hideModal('profile-modal');
    }
    function deleteCurrentProfile() {
      if (babyProfiles.length <= 1) {
        alert('You cannot delete the only profile.');
        return;
      }
      const profile = babyProfiles.find(p => p.id == currentProfileId);
      if (confirm(`Are you sure you want to delete ${profile.babyName}'s profile? All data will be lost forever.`)) {
        babyProfiles = babyProfiles.filter(p => p.id != profile.id);
        currentProfileId = babyProfiles.length > 0 ? babyProfiles[0].id : null;
        saveProfiles();
        initializeApp();
        hideModal('profile-modal');
      }
    }
    function populateProfileSwitcher() {
      const switcher = document.getElementById('profile-switcher');
      switcher.innerHTML = '';
      babyProfiles.forEach(p => {
        switcher.innerHTML += `<option value="${p.id}" ${p.id == currentProfileId ? 'selected' : ''}>${p.babyName}</option>`;
      });
    }
    function saveProfiles() {
      localStorage.setItem('babyProfiles', JSON.stringify(babyProfiles));
      localStorage.setItem('currentProfileId', currentProfileId);
    }
    function loadProfiles() {
      babyProfiles = JSON.parse(localStorage.getItem('babyProfiles') || '[]');
      currentProfileId = localStorage.getItem('currentProfileId');
      if (!currentProfileId && babyProfiles.length > 0) {
        currentProfileId = babyProfiles[0].id;
      }
    }
    function initializeApp() {
      loadProfiles();
      if (babyProfiles.length === 0) {
        showModal('welcome-modal');
        return;
      }
      loadData();
      populateProfileSwitcher();
      renderActivityLog();
      renderMoodAnalytics();
      updateMilestoneTicker();
      renderGrowthHistory();
      renderInventory();
      renderFeedingSchedule();
      renderReminders();
      renderAppointments();
      updateAppointmentStats();
      
      // Update header
      const profile = babyProfiles.find(p => p.id == currentProfileId);
      if (profile) {
        document.getElementById('header-title').textContent = `Hello, ${profile.userName}!`;
        document.getElementById('header-subtitle').textContent = `${profile.babyName} is ${calculatePreciseAge(profile.dob)}`;
      }
      
      // Update daily stats for today
      updateDailyStats(new Date());
      // Update header stats
      updateHeaderStats();
    }
    function calculatePreciseAge(dobString) {
      const dob = new Date(dobString), today = new Date();
      if (dob > today) return 'not born yet!';
      let years = today.getFullYear() - dob.getFullYear(), months = today.getMonth() - dob.getMonth(), days = today.getDate() - dob.getDate();
      if (days < 0) { months--; days += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); }
      if (months < 0) { years--; months += 12; }
      if (years >= 2) return `${years} years old`;
      if (years > 0) return `${years} year${years > 1 ? 's' : ''} & ${months} month${months > 1 ? 's' : ''} old`;
      const totalDays = Math.floor((today - dob) / (1e3 * 60 * 60 * 24));
      if (totalDays < 7) return `${totalDays} day${totalDays !== 1 ? 's' : ''} old`;
      const weeks = Math.floor(totalDays / 7);
      if (months < 1) return `${weeks} week${weeks > 1 ? 's' : ''} old`;
      return `${months} month${months > 1 ? 's' : ''} old`;
    }
    // --- INVENTORY MANAGEMENT ---
    function updateInventory(itemType, action, quantity) {
      const currentAmount = inventory[itemType] || 0;
      
      switch (action) {
        case 'add':
          inventory[itemType] = currentAmount + quantity;
          break;
        case 'use':
          inventory[itemType] = Math.max(0, currentAmount - quantity);
          break;
        case 'set':
          inventory[itemType] = quantity;
          break;
      }
      
      saveData();
      renderInventory();
    }
    
    function renderInventory() {
      document.getElementById('diapers-count').textContent = inventory.diapers;
      document.getElementById('wipes-count').textContent = inventory.wipes;
      document.getElementById('formula-count').textContent = inventory.formula;
      document.getElementById('medicine-count').textContent = inventory.medicine;
      
      // Add visual indicators for low stock
      const lowStockThreshold = 5;
      Object.keys(inventory).forEach(item => {
        const countElement = document.getElementById(`${item}-count`);
        if (inventory[item] <= lowStockThreshold && inventory[item] > 0) {
          countElement.classList.add('text-orange-500');
          countElement.classList.remove('text-green-600');
        } else if (inventory[item] === 0) {
          countElement.classList.add('text-red-500');
          countElement.classList.remove('text-green-600', 'text-orange-500');
        } else {
          countElement.classList.add('text-green-600');
          countElement.classList.remove('text-orange-500', 'text-red-500');
        }
      });
    }
    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize dark mode - default to dark mode
      const savedDarkMode = localStorage.getItem('darkMode');
      if (savedDarkMode === null || savedDarkMode === 'true') {
        // Default to dark mode if no preference saved or if it was previously enabled
        document.documentElement.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
        // Update the toggle button icon
        const btn = document.querySelector('button[onclick="toggleDarkMode()"] i');
        if (btn) btn.className = 'fas fa-sun text-yellow-500 text-2xl';
      } else {
        // User has explicitly disabled dark mode
        document.documentElement.classList.remove('dark');
        const btn = document.querySelector('button[onclick="toggleDarkMode()"] i');
        if (btn) btn.className = 'fas fa-moon text-indigo-500 text-2xl';
      }
      
      renderActivityButtons();
      startDateTime();
      fetchWeather();
      loadProfiles();
      
      // Setup activity form
      const activityForm = document.getElementById('activity-form');
      if (activityForm) {
        activityForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const activityType = document.getElementById('activity-type').value;
          const activityTime = document.getElementById('activity-time').value;
          const activityNotes = document.getElementById('activity-notes').value;
          
          if (!activityType || !activityTime) {
            alert('Please fill in all required fields.');
            return;
          }
          
          // Get selected mood if it's a mood activity
          let selectedMood = null;
          if (activityType === 'mood') {
            const selectedMoodBtn = document.querySelector('.mood-btn.selected');
            if (selectedMoodBtn) {
              selectedMood = selectedMoodBtn.dataset.mood;
            }
          }
          
          // Get quantity if it's a feed activity
          let quantity = null;
          let feedType = null;
          if (activityType === 'feed') {
            const quantityInput = document.getElementById('feed-quantity');
            const feedTypeInput = document.getElementById('feed-type');
            if (quantityInput && quantityInput.value) {
              quantity = parseFloat(quantityInput.value);
            }
            if (feedTypeInput && feedTypeInput.value) {
              feedType = feedTypeInput.value;
            }
          }
          
          addEntry(activityType, activityTime, activityNotes, selectedMood, quantity, feedType);
          hideModal('log-modal');
          this.reset();
          document.getElementById('feed-quantity-section').classList.add('hidden');
        });
      }
      
      // Setup mood selection
      document.querySelectorAll('.mood-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected', 'scale-125'));
          this.classList.add('selected', 'scale-125');
        });
      });
      
      // Populate activity type dropdown
      const activityTypeSelect = document.getElementById('activity-type');
      if (activityTypeSelect) {
        const allActivities = [...defaultActivities, ...customActivities];
        activityTypeSelect.innerHTML += allActivities
          .map(act => `<option value="${act.id}">${act.name}</option>`).join('');
      }
      
      // Populate edit activity type dropdown
      const editActivityTypeSelect = document.getElementById('edit-activity-type');
      if (editActivityTypeSelect) {
        const allActivities = [...defaultActivities, ...customActivities];
        editActivityTypeSelect.innerHTML = '<option value="">Select activity...</option>' +
          allActivities.map(act => `<option value="${act.id}">${act.name}</option>`).join('');
      }
      
      // Setup feed type and quantity change handlers for inventory impact
      const feedTypeSelect = document.getElementById('feed-type');
      const feedQuantityInput = document.getElementById('feed-quantity');
      
      if (feedTypeSelect) {
        feedTypeSelect.addEventListener('change', function() {
          updateFeedInventoryImpact();
        });
      }
      
      if (feedQuantityInput) {
        feedQuantityInput.addEventListener('input', function() {
          updateFeedInventoryImpact();
        });
      }
      
      // Setup file import
      const restoreFileInput = document.getElementById('restore-file');
      if (restoreFileInput) {
        restoreFileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            importData(file);
            this.value = ''; // Reset input
          }
        });
      }
      
      // Setup milestone form
      const milestoneForm = document.getElementById('milestone-form');
      if (milestoneForm) {
        milestoneForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const type = document.getElementById('milestone-type').value;
          const date = document.getElementById('milestone-date').value;
          const notes = document.getElementById('milestone-notes').value;
          const customText = document.getElementById('custom-milestone-text').value;
          
          if (!type || !date) {
            alert('Please fill in all required fields.');
            return;
          }
          
          addMilestone(type, date, notes, customText);
          hideModal('milestone-modal');
          this.reset();
          document.getElementById('custom-milestone-input').classList.add('hidden');
        });
      }
      
      // Setup milestone type change handler
      const milestoneTypeSelect = document.getElementById('milestone-type');
      if (milestoneTypeSelect) {
        milestoneTypeSelect.addEventListener('change', function() {
          const customInput = document.getElementById('custom-milestone-input');
          if (this.value === 'custom') {
            customInput.classList.remove('hidden');
          } else {
            customInput.classList.add('hidden');
          }
        });
      }
      
      // Setup growth form
      const growthForm = document.getElementById('growth-form');
      if (growthForm) {
        growthForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const type = document.getElementById('measurement-type').value;
          const value = document.getElementById('measurement-value').value;
          const unit = document.getElementById('measurement-unit').value;
          const date = document.getElementById('measurement-date').value;
          
          if (!type || !value || !unit || !date) {
            alert('Please fill in all required fields.');
            return;
          }
          
          // Validate the measurement value
          if (!validateMeasurementValue(value, type, unit)) {
            alert('Please enter a valid measurement value. Check the format hints below the input field.');
            return;
          }
          
          // Parse the measurement value
          const parsedValue = parseMeasurementValue(value, type, unit);
          if (parsedValue === null) {
            alert('Unable to parse the measurement value. Please check the format and try again.');
            return;
          }
          
          addGrowthMeasurement(type, parsedValue, unit, date);
          this.reset();
          updateMeasurementFields(); // Reset the dynamic fields
        });
      }
      
      // Setup custom timer form
      const customTimerForm = document.getElementById('custom-timer-form');
      if (customTimerForm) {
        customTimerForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const activity = document.getElementById('custom-timer-activity').value;
          const duration = document.getElementById('custom-timer-duration').value;
          
          if (!activity || !duration) {
            alert('Please fill in all required fields.');
            return;
          }
          
          const durationNum = parseInt(duration);
          if (durationNum < 1 || durationNum > 480) {
            alert('Duration must be between 1 and 480 minutes.');
            return;
          }
          
          startQuickTimer(activity, durationNum);
          this.reset();
        });
      }
      
      // Setup inventory form
      const inventoryForm = document.getElementById('inventory-form');
      if (inventoryForm) {
        inventoryForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const itemType = document.getElementById('inventory-item-type').value;
          const quantity = parseInt(document.getElementById('inventory-quantity').value);
          const action = document.getElementById('inventory-action').value;
          
          if (!itemType || isNaN(quantity) || quantity < 0) {
            alert('Please fill in all required fields with valid values.');
            return;
          }
          
          updateInventory(itemType, action, quantity);
          this.reset();
          hideModal('inventory-modal');
        });
      }
      
      // Setup activity editor form
      const activityEditorForm = document.getElementById('activity-editor-form');
      if (activityEditorForm) {
        activityEditorForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const activityId = document.getElementById('edit-activity-id').value;
          const activityType = document.getElementById('edit-activity-type').value;
          const activityTime = document.getElementById('edit-activity-time').value;
          const activityNotes = document.getElementById('edit-activity-notes').value;
          
          if (!activityId || !activityType || !activityTime) {
            alert('Please fill in all required fields.');
            return;
          }
          
          // Find and update the activity
          const activityIndex = activityLog.findIndex(entry => entry.id === activityId);
          if (activityIndex === -1) {
            alert('Activity not found.');
            return;
          }
          
          // Get selected mood if it's a mood activity
          let selectedMood = null;
          if (activityType === 'mood') {
            const selectedMoodBtn = document.querySelector('.edit-mood-btn.selected');
            if (selectedMoodBtn) {
              selectedMood = selectedMoodBtn.dataset.mood;
            }
          }
          
          // Get quantity if it's a feed activity
          let quantity = null;
          let feedType = null;
          if (activityType === 'feed') {
            const quantityInput = document.getElementById('edit-feed-quantity');
            const feedTypeInput = document.getElementById('edit-feed-type');
            if (quantityInput && quantityInput.value) {
              quantity = parseFloat(quantityInput.value);
            }
            if (feedTypeInput && feedTypeInput.value) {
              feedType = feedTypeInput.value;
            }
          }
          
          // Get the old activity data for inventory restoration
          const oldActivity = activityLog[activityIndex];
          
          // Restore inventory from the old activity
          restoreInventoryFromActivity(oldActivity.type, oldActivity.quantity, oldActivity.feedType);
          
          // Update the activity
          activityLog[activityIndex] = {
            ...activityLog[activityIndex],
            type: activityType,
            timestamp: activityTime,
            notes: activityNotes,
            mood: selectedMood,
            quantity: quantity,
            feedType: feedType
          };
          
          // Deduct inventory for the new activity
          deductInventoryForActivity(activityType, quantity, feedType);
          
          saveData();
          renderActivityLog();
          renderMoodAnalytics();
          hideModal('activity-editor-modal');
        });
      }
      
      // Setup edit mood selection
      document.querySelectorAll('.edit-mood-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.edit-mood-btn').forEach(b => b.classList.remove('selected', 'scale-125'));
          this.classList.add('selected', 'scale-125');
        });
      });
      
      // Setup feeding schedule form
      const addScheduleForm = document.getElementById('add-schedule-form');
      if (addScheduleForm) {
        addScheduleForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const type = document.getElementById('schedule-feeding-type').value;
          const time = document.getElementById('schedule-time').value;
          const notes = document.getElementById('schedule-notes').value;
          const repeat = document.getElementById('schedule-repeat').value;
          
          if (!type || !time) {
            alert('Please fill in all required fields.');
            return;
          }
          
          addFeedingSchedule(type, time, notes, repeat);
          this.reset();
          hideModal('add-schedule-modal');
        });
      }
      
      // Setup reminder form
      const addReminderForm = document.getElementById('add-reminder-form');
      if (addReminderForm) {
        addReminderForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const type = document.getElementById('reminder-type').value;
          const time = document.getElementById('reminder-time').value;
          const date = document.getElementById('reminder-date').value;
          const notes = document.getElementById('reminder-notes').value;
          const repeat = document.getElementById('reminder-repeat').value;
          const customText = document.getElementById('custom-reminder-text').value;
          
          if (!type || !time || !date) {
            alert('Please fill in all required fields.');
            return;
          }
          
          addReminder(type, time, date, notes, repeat, customText);
          this.reset();
          hideModal('add-reminder-modal');
        });
      }
      
      // Setup reminder type change handler
      const reminderTypeSelect = document.getElementById('reminder-type');
      if (reminderTypeSelect) {
        reminderTypeSelect.addEventListener('change', function() {
          const customInput = document.getElementById('custom-reminder-input');
          if (this.value === 'custom') {
            customInput.classList.remove('hidden');
          } else {
            customInput.classList.add('hidden');
          }
        });
      }
      
      // Setup appointment form
      const addAppointmentForm = document.getElementById('add-appointment-form');
      if (addAppointmentForm) {
        addAppointmentForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const date = document.getElementById('appointment-date').value;
          const time = document.getElementById('appointment-time').value;
          const doctorName = document.getElementById('doctor-name').value;
          const type = document.getElementById('appointment-type').value;
          const location = document.getElementById('appointment-location').value;
          const reason = document.getElementById('appointment-reason').value;
          const notes = document.getElementById('appointment-notes').value;
          const reminder = document.getElementById('appointment-reminder').value;
          const status = document.getElementById('appointment-status').value;
          
          if (!date || !time || !doctorName || !type || !location || !reason) {
            alert('Please fill in all required fields.');
            return;
          }
          
          addAppointment(date, time, doctorName, type, location, reason, notes, reminder, status);
          this.reset();
          hideModal('add-appointment-modal');
        });
      }
      
      // Setup visit summary form
      const visitSummaryForm = document.getElementById('visit-summary-form');
      if (visitSummaryForm) {
        visitSummaryForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const appointmentId = document.getElementById('summary-appointment-id').value;
          const diagnosis = document.getElementById('visit-diagnosis').value;
          const treatment = document.getElementById('visit-treatment').value;
          const medications = document.getElementById('visit-medications').value;
          const followup = document.getElementById('visit-followup').value;
          const notes = document.getElementById('visit-notes').value;
          
          const appointment = appointments.find(a => a.id === appointmentId);
          if (!appointment) return;
          
          appointment.visitSummary = {
            diagnosis: diagnosis,
            treatment: treatment,
            medications: medications,
            followup: followup,
            notes: notes,
            timestamp: new Date().toISOString()
          };
          
          saveData();
          viewAppointmentDetails(appointmentId); // Refresh the view
          this.reset();
        });
      }
      
      // Update tot report button to use enhanced function
      const totReportButton = document.querySelector('[onclick="showModal(\'tot-report-modal\')"]');
      if (totReportButton) {
        totReportButton.onclick = showTotReportModal;
      }
      
      // Setup reset confirmation
      setupResetConfirmation();
      
      if (babyProfiles.length === 0) {
        showModal('welcome-modal');
      } else {
        initializeApp();
      }
    });
    // Expose for modal buttons
    window.showModal = showModal;
    window.hideModal = hideModal;
    window.saveBabyInfo = saveBabyInfo;
    window.showSetupForNewProfile = showSetupForNewProfile;
    window.switchProfile = switchProfile;
    window.deleteCurrentProfile = deleteCurrentProfile;
    window.quickLogActivity = quickLogActivity;
    window.exportData = exportData;
    window.importData = importData;
    window.generateTotReport = generateTotReport;
    window.selectTimerActivity = selectTimerActivity;
    window.startTimer = startTimer;
    window.stopTimer = stopTimer;
    window.startQuickTimer = startQuickTimer;
    window.updateInventory = updateInventory;
    window.quickInventoryAction = quickInventoryAction;
    window.editActivity = editActivity;
    window.deleteActivity = deleteActivity;
    window.markFeedingComplete = markFeedingComplete;
    window.deleteFeedingSchedule = deleteFeedingSchedule;
    window.markReminderComplete = markReminderComplete;
    window.deleteReminder = deleteReminder;
    window.viewAppointmentDetails = viewAppointmentDetails;
    window.markAppointmentComplete = markAppointmentComplete;
    window.deleteAppointment = deleteAppointment;
    window.confirmResetApp = confirmResetApp;
    window.showResetAppModal = showResetAppModal;
    window.updateMeasurementFields = updateMeasurementFields;
    window.showGrowthChart = showGrowthChart;
    window.toggleFeedQuantityField = toggleFeedQuantityField;
    window.toggleEditFeedQuantityField = toggleEditFeedQuantityField;
    
    // Enhanced modal functions
    function showTotReportModal() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('report-date').value = today;
      updateDailyStats(new Date());
      showModal('tot-report-modal');
    }
    
    function showResetAppModal() {
      // Clear any existing confirmation input
      const resetInput = document.getElementById('reset-confirmation');
      const resetBtn = document.getElementById('reset-confirm-btn');
      if (resetInput) {
        resetInput.value = '';
      }
      if (resetBtn) {
        resetBtn.disabled = true;
        resetBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
      showModal('reset-app-modal');
    }
    // --- ACTIVITY EDITING ---
    function editActivity(activityId) {
      const activity = activityLog.find(entry => entry.id === activityId);
      if (!activity) return;
      
      // Populate the edit form
      document.getElementById('edit-activity-id').value = activityId;
      document.getElementById('edit-activity-type').value = activity.type;
      document.getElementById('edit-activity-time').value = activity.timestamp.slice(0, 16);
      document.getElementById('edit-activity-notes').value = activity.notes || '';
      
      // Handle quantity section for feed activities
      const editQuantitySection = document.getElementById('edit-feed-quantity-section');
      if (activity.type === 'feed') {
        editQuantitySection.classList.remove('hidden');
        document.getElementById('edit-feed-quantity').value = activity.quantity || '';
        document.getElementById('edit-feed-type').value = activity.feedType || '';
      } else {
        editQuantitySection.classList.add('hidden');
      }
      
      // Handle mood section
      const editMoodSection = document.getElementById('edit-mood-section');
      if (activity.type === 'mood') {
        editMoodSection.classList.remove('hidden');
        // Set selected mood
        document.querySelectorAll('.edit-mood-btn').forEach(btn => {
          btn.classList.remove('selected', 'scale-125');
          if (btn.dataset.mood === activity.mood) {
            btn.classList.add('selected', 'scale-125');
          }
        });
      } else {
        editMoodSection.classList.add('hidden');
      }
      
      // Handle inventory status section
      const editInventorySection = document.getElementById('edit-inventory-status-section');
      if (editInventorySection) {
        if (activity.type === 'diaper' || activity.type === 'feed' || activity.type === 'medication') {
          editInventorySection.classList.remove('hidden');
          updateEditInventoryImpact(activity.type, activity.quantity, activity.feedType);
        } else {
          editInventorySection.classList.add('hidden');
        }
      }
      
      showModal('activity-editor-modal');
    }
    
    function deleteActivity() {
      const activityId = document.getElementById('edit-activity-id').value;
      if (!activityId) return;
      
      if (confirm('Are you sure you want to delete this activity? This action cannot be undone.')) {
        // Find the activity before removing it
        const deletedActivity = activityLog.find(entry => entry.id === activityId);
        
        if (deletedActivity) {
          // Restore inventory from the deleted activity
          restoreInventoryFromActivity(deletedActivity.type, deletedActivity.quantity, deletedActivity.feedType);
          
          // Update mood analytics if it was a mood activity
          if (deletedActivity.mood) {
            moodAnalytics.total = Math.max(0, moodAnalytics.total - 1);
            moodAnalytics.moods[deletedActivity.mood] = Math.max(0, (moodAnalytics.moods[deletedActivity.mood] || 0) - 1);
          }
        }
        
        // Remove from activity log
        activityLog = activityLog.filter(entry => entry.id !== activityId);
        
        saveData();
        renderActivityLog();
        renderMoodAnalytics();
        hideModal('activity-editor-modal');
      }
    }
    
    function quickInventoryAction(itemType, action, quantity) {
      updateInventory(itemType, action, quantity);
      hideModal('inventory-modal');
    }
    // --- FEEDING SCHEDULE ---
    function addFeedingSchedule(type, time, notes, repeat) {
      const schedule = {
        id: Date.now().toString(),
        type: type,
        time: time,
        notes: notes,
        repeat: repeat,
        date: new Date().toISOString().split('T')[0],
        timestamp: new Date().toISOString()
      };
      
      feedingSchedules.push(schedule);
      saveData();
      renderFeedingSchedule();
    }
    
    function renderFeedingSchedule() {
      const container = $('#feeding-schedule-list');
      if (!container) return;
      
      const today = new Date().toISOString().split('T')[0];
      const todaySchedules = feedingSchedules.filter(schedule => schedule.date === today);
      
      if (todaySchedules.length === 0) {
        container.innerHTML = '<p class="text-secondary text-center py-4">No feeding schedule set for today.</p>';
        return;
      }
      
      // Sort by time
      todaySchedules.sort((a, b) => a.time.localeCompare(b.time));
      
      container.innerHTML = todaySchedules.map(schedule => {
        const typeNames = {
          'breast': 'Breastfeeding',
          'bottle': 'Bottle Feeding',
          'solid': 'Solid Food',
          'snack': 'Snack'
        };
        
        const typeIcons = {
          'breast': 'fas fa-baby text-pink-500',
          'bottle': 'fas fa-baby-carriage text-purple-500',
          'solid': 'fas fa-utensils text-orange-500',
          'snack': 'fas fa-apple-alt text-green-500'
        };
        
        return `
          <div class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-800/50 rounded-lg">
            <div class="flex items-center">
              <i class="${typeIcons[schedule.type]} text-xl mr-3"></i>
              <div>
                <div class="font-semibold text-primary">${typeNames[schedule.type]}</div>
                <div class="text-sm text-secondary">${schedule.time}${schedule.notes ? ` - ${schedule.notes}` : ''}</div>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="markFeedingComplete('${schedule.id}')" class="text-green-500 hover:text-green-700 transition-colors" title="Mark as complete">
                <i class="fas fa-check"></i>
              </button>
              <button onclick="deleteFeedingSchedule('${schedule.id}')" class="text-red-500 hover:text-red-700 transition-colors" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function markFeedingComplete(scheduleId) {
      const schedule = feedingSchedules.find(s => s.id === scheduleId);
      if (!schedule) return;
      
      // Add to activity log with feed type
      const feedType = schedule.type === 'breast' ? 'breast' : 'formula';
      addEntry('feed', new Date().toISOString(), `Scheduled: ${schedule.type} at ${schedule.time}${schedule.notes ? ` - ${schedule.notes}` : ''}`, null, null, feedType);
      
      // Remove from schedule
      feedingSchedules = feedingSchedules.filter(s => s.id !== scheduleId);
      saveData();
      renderFeedingSchedule();
    }
    
    function deleteFeedingSchedule(scheduleId) {
      if (confirm('Are you sure you want to delete this feeding schedule?')) {
        feedingSchedules = feedingSchedules.filter(s => s.id !== scheduleId);
        saveData();
        renderFeedingSchedule();
      }
    }
    // --- REMINDERS ---
    function addReminder(type, time, date, notes, repeat, customText = '') {
      const reminder = {
        id: Date.now().toString(),
        type: type,
        time: time,
        date: date,
        notes: notes,
        repeat: repeat,
        customText: customText,
        completed: false,
        timestamp: new Date().toISOString()
      };
      
      reminders.push(reminder);
      saveData();
      renderReminders();
    }
    
    function renderReminders() {
      const container = $('#reminders-list');
      if (!container) return;
      
      const today = new Date().toISOString().split('T')[0];
      const activeReminders = reminders.filter(reminder => !reminder.completed && reminder.date >= today);
      
      if (activeReminders.length === 0) {
        container.innerHTML = '<p class="text-secondary text-center py-4">No reminders set.</p>';
        return;
      }
      
      // Sort by date and time
      activeReminders.sort((a, b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return a.time.localeCompare(b.time);
      });
      
      container.innerHTML = activeReminders.map(reminder => {
        const typeNames = {
          'feed': 'Feeding',
          'diaper': 'Diaper Change',
          'sleep': 'Sleep/Nap',
          'medicine': 'Medicine',
          'appointment': 'Appointment',
          'custom': reminder.customText || 'Custom'
        };
        
        const typeIcons = {
          'feed': 'fas fa-utensils text-blue-500',
          'diaper': 'fas fa-baby text-amber-500',
          'sleep': 'fas fa-moon text-indigo-500',
          'medicine': 'fas fa-pills text-cyan-500',
          'appointment': 'fas fa-calendar text-purple-500',
          'custom': 'fas fa-bell text-orange-500'
        };
        
        const isToday = reminder.date === today;
        const dateDisplay = isToday ? 'Today' : new Date(reminder.date).toLocaleDateString();
        
        return `
          <div class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-800/50 rounded-lg">
            <div class="flex items-center">
              <i class="${typeIcons[reminder.type]} text-xl mr-3"></i>
              <div>
                <div class="font-semibold text-primary">${typeNames[reminder.type]}</div>
                <div class="text-sm text-secondary">${dateDisplay} at ${reminder.time}${reminder.notes ? ` - ${reminder.notes}` : ''}</div>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="markReminderComplete('${reminder.id}')" class="text-green-500 hover:text-green-700 transition-colors" title="Mark as complete">
                <i class="fas fa-check"></i>
              </button>
              <button onclick="deleteReminder('${reminder.id}')" class="text-red-500 hover:text-red-700 transition-colors" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function markReminderComplete(reminderId) {
      const reminder = reminders.find(r => r.id === reminderId);
      if (!reminder) return;
      
      reminder.completed = true;
      saveData();
      renderReminders();
    }
    
    function deleteReminder(reminderId) {
      if (confirm('Are you sure you want to delete this reminder?')) {
        reminders = reminders.filter(r => r.id !== reminderId);
        saveData();
        renderReminders();
      }
    }
    // --- APPOINTMENTS ---
    function addAppointment(date, time, doctorName, type, location, reason, notes, reminder, status) {
      const appointment = {
        id: Date.now().toString(),
        date: date,
        time: time,
        doctorName: doctorName,
        type: type,
        location: location,
        reason: reason,
        notes: notes,
        reminder: reminder,
        status: status,
        visitSummary: null,
        timestamp: new Date().toISOString()
      };
      
      appointments.push(appointment);
      saveData();
      renderAppointments();
      updateAppointmentStats();
      
      // Add to activity log if completed
      if (status === 'completed') {
        addEntry('appointment', `${date}T${time}`, `Doctor: ${doctorName} - ${type}`, null);
      }
    }
    
    function renderAppointments() {
      const container = $('#appointments-list');
      if (!container) return;
      
      const today = new Date().toISOString().split('T')[0];
      const upcomingAppointments = appointments
        .filter(appointment => appointment.date >= today && appointment.status !== 'cancelled')
        .sort((a, b) => {
          if (a.date !== b.date) return a.date.localeCompare(b.date);
          return a.time.localeCompare(b.time);
        });
      
      if (upcomingAppointments.length === 0) {
        container.innerHTML = '<p class="text-secondary text-center py-4">No appointments scheduled.</p>';
        return;
      }
      
      container.innerHTML = upcomingAppointments.map(appointment => {
        const typeNames = {
          'pediatrician': 'Pediatrician',
          'family-medicine': 'Family Medicine',
          'vaccination': 'Vaccination',
          'wellness-check': 'Wellness Check',
          'sick-visit': 'Sick Visit',
          'follow-up': 'Follow-up',
          'specialist': 'Specialist',
          'emergency': 'Emergency',
          'other': 'Other'
        };
        
        const typeIcons = {
          'pediatrician': 'fas fa-user-md text-blue-500',
          'family-medicine': 'fas fa-stethoscope text-green-500',
          'vaccination': 'fas fa-syringe text-purple-500',
          'wellness-check': 'fas fa-heartbeat text-pink-500',
          'sick-visit': 'fas fa-thermometer text-red-500',
          'follow-up': 'fas fa-arrow-right text-indigo-500',
          'specialist': 'fas fa-user-md text-orange-500',
          'emergency': 'fas fa-ambulance text-red-600',
          'other': 'fas fa-hospital text-gray-500'
        };
        
        const statusColors = {
          'scheduled': 'bg-yellow-100 text-yellow-800',
          'confirmed': 'bg-blue-100 text-blue-800',
          'completed': 'bg-green-100 text-green-800',
          'cancelled': 'bg-red-100 text-red-800'
        };
        
        const isToday = appointment.date === today;
        const dateDisplay = isToday ? 'Today' : new Date(appointment.date).toLocaleDateString();
        
        return `
          <div class="flex items-center justify-between p-4 bg-white/50 dark:bg-slate-800/50 rounded-lg">
            <div class="flex items-center flex-1">
              <i class="${typeIcons[appointment.type]} text-xl mr-3"></i>
              <div class="flex-1">
                <div class="flex items-center space-x-2">
                  <div class="font-semibold text-primary">${typeNames[appointment.type]}</div>
                  <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[appointment.status]}">${appointment.status}</span>
                </div>
                <div class="text-sm text-secondary">${dateDisplay} at ${appointment.time}</div>
                <div class="text-sm text-secondary">Dr. ${appointment.doctorName} - ${appointment.location}</div>
                <div class="text-sm text-secondary mt-1">${appointment.reason}</div>
              </div>
            </div>
            <div class="flex items-center space-x-2 ml-4">
              <button onclick="viewAppointmentDetails('${appointment.id}')" class="text-blue-500 hover:text-blue-700 transition-colors" title="View details">
                <i class="fas fa-eye"></i>
              </button>
              <button onclick="editAppointment('${appointment.id}')" class="text-green-500 hover:text-green-700 transition-colors" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteAppointment('${appointment.id}')" class="text-red-500 hover:text-red-700 transition-colors" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function updateAppointmentStats() {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      // Filter appointments for current month
      const monthAppointments = appointments.filter(appointment => {
        const appointmentDate = new Date(appointment.date);
        return appointmentDate.getMonth() === currentMonth && 
               appointmentDate.getFullYear() === currentYear;
      });
      
      const upcoming = monthAppointments.filter(a => a.date >= today.toISOString().split('T')[0] && a.status !== 'cancelled').length;
      const completed = monthAppointments.filter(a => a.status === 'completed').length;
      
      document.getElementById('stats-upcoming').textContent = upcoming;
      document.getElementById('stats-completed').textContent = completed;
      
      // Find next visit
      const nextVisit = appointments
        .filter(a => a.date >= today.toISOString().split('T')[0] && a.status !== 'cancelled')
        .sort((a, b) => a.date.localeCompare(b.date))[0];
      
      if (nextVisit) {
        const nextDate = new Date(nextVisit.date);
        const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
        document.getElementById('stats-next-visit').textContent = daysUntil === 0 ? 'Today' : `${daysUntil} days`;
      } else {
        document.getElementById('stats-next-visit').textContent = '-';
      }
      
      // Recent visits
      const recentVisits = appointments
        .filter(a => a.status === 'completed')
        .sort((a, b) => b.date.localeCompare(a.date))
        .slice(0, 3);
      
      const recentVisitsContainer = $('#recent-visits');
      if (recentVisits.length === 0) {
        recentVisitsContainer.innerHTML = '<p class="text-secondary text-center">No recent visits</p>';
      } else {
        recentVisitsContainer.innerHTML = recentVisits.map(visit => {
          const visitDate = new Date(visit.date);
          const daysAgo = Math.ceil((today - visitDate) / (1000 * 60 * 60 * 24));
          return `
            <div class="flex justify-between text-sm">
              <span>${visit.doctorName}</span>
              <span class="font-medium">${daysAgo}d ago</span>
            </div>
          `;
        }).join('');
      }
    }
    
    function viewAppointmentDetails(appointmentId) {
      const appointment = appointments.find(a => a.id === appointmentId);
      if (!appointment) return;
      
      const typeNames = {
        'pediatrician': 'Pediatrician',
        'family-medicine': 'Family Medicine',
        'vaccination': 'Vaccination',
        'wellness-check': 'Wellness Check',
        'sick-visit': 'Sick Visit',
        'follow-up': 'Follow-up',
        'specialist': 'Specialist',
        'emergency': 'Emergency',
        'other': 'Other'
      };
      
      const statusColors = {
        'scheduled': 'bg-yellow-100 text-yellow-800',
        'confirmed': 'bg-blue-100 text-blue-800',
        'completed': 'bg-green-100 text-green-800',
        'cancelled': 'bg-red-100 text-red-800'
      };
      
      // Populate appointment details
      const detailsContent = $('#appointment-details-content');
      detailsContent.innerHTML = `
        <div class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4 space-y-3">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-primary">${typeNames[appointment.type]}</h4>
            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[appointment.status]}">${appointment.status}</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div><span class="font-medium">Date:</span> ${new Date(appointment.date).toLocaleDateString()}</div>
            <div><span class="font-medium">Time:</span> ${appointment.time}</div>
            <div><span class="font-medium">Doctor:</span> ${appointment.doctorName}</div>
            <div><span class="font-medium">Location:</span> ${appointment.location}</div>
          </div>
          <div><span class="font-medium">Reason:</span> ${appointment.reason}</div>
          ${appointment.notes ? `<div><span class="font-medium">Notes:</span> ${appointment.notes}</div>` : ''}
          ${appointment.reminder !== 'none' ? `<div><span class="font-medium">Reminder:</span> ${appointment.reminder}</div>` : ''}
        </div>
      `;
      
      // Populate visit summary if exists
      if (appointment.visitSummary) {
        const summaryContent = $('#visit-summary-content');
        summaryContent.innerHTML = `
          <div class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4">
            <h4 class="font-semibold text-primary mb-3">Visit Summary</h4>
            <div class="space-y-3 text-sm">
              ${appointment.visitSummary.diagnosis ? `<div><span class="font-medium">Diagnosis:</span> ${appointment.visitSummary.diagnosis}</div>` : ''}
              ${appointment.visitSummary.treatment ? `<div><span class="font-medium">Treatment:</span> ${appointment.visitSummary.treatment}</div>` : ''}
              ${appointment.visitSummary.medications ? `<div><span class="font-medium">Medications:</span> ${appointment.visitSummary.medications}</div>` : ''}
              ${appointment.visitSummary.followup ? `<div><span class="font-medium">Follow-up:</span> ${appointment.visitSummary.followup}</div>` : ''}
              ${appointment.visitSummary.notes ? `<div><span class="font-medium">Notes:</span> ${appointment.visitSummary.notes}</div>` : ''}
            </div>
          </div>
        `;
      } else {
        // Show form for adding summary
        const summaryContent = $('#visit-summary-content');
        summaryContent.innerHTML = `
          <div class="bg-white/50 dark:bg-slate-800/50 rounded-lg p-4">
            <h4 class="font-semibold text-primary mb-3">Add Visit Summary</h4>
            <form id="visit-summary-form" class="space-y-3">
              <input type="hidden" id="summary-appointment-id" value="${appointment.id}">
              <div>
                <label class="block text-sm font-medium text-secondary mb-1">Diagnosis/Findings</label>
                <textarea id="visit-diagnosis" class="input-enhanced w-full h-20 resize-none" placeholder="What did the doctor find?"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-secondary mb-1">Treatment/Recommendations</label>
                <textarea id="visit-treatment" class="input-enhanced w-full h-20 resize-none" placeholder="What treatment was prescribed?"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-secondary mb-1">Medications</label>
                <textarea id="visit-medications" class="input-enhanced w-full h-20 resize-none" placeholder="Any medications prescribed?"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-secondary mb-1">Follow-up</label>
                <textarea id="visit-followup" class="input-enhanced w-full h-20 resize-none" placeholder="When to follow up?"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-secondary mb-1">Notes</label>
                <textarea id="visit-notes" class="input-enhanced w-full h-20 resize-none" placeholder="Additional notes..."></textarea>
              </div>
              <div class="flex space-x-3">
                <button type="submit" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                  Save Summary
                </button>
                <button type="button" onclick="markAppointmentComplete()" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                  Mark Complete
                </button>
              </div>
            </form>
          </div>
        `;
      }
      
      document.getElementById('summary-appointment-id').value = appointmentId;
      showModal('appointment-details-modal');
    }
    
    function markAppointmentComplete() {
      const appointmentId = document.getElementById('summary-appointment-id').value;
      const appointment = appointments.find(a => a.id === appointmentId);
      if (!appointment) return;
      
      appointment.status = 'completed';
      saveData();
      renderAppointments();
      updateAppointmentStats();
      hideModal('appointment-details-modal');
      
      // Add to activity log
      addEntry('appointment', `${appointment.date}T${appointment.time}`, `Doctor: ${appointment.doctorName} - ${appointment.type}`, null);
    }
    
    function deleteAppointment(appointmentId) {
      if (confirm('Are you sure you want to delete this appointment?')) {
        appointments = appointments.filter(a => a.id !== appointmentId);
        saveData();
        renderAppointments();
        updateAppointmentStats();
      }
    }
    // --- APP RESET FUNCTIONALITY ---
    function confirmResetApp() {
      const confirmation = document.getElementById('reset-confirmation').value.trim();
      if (confirmation !== 'RESET') {
        alert('Please type "RESET" exactly to confirm the deletion.');
        return;
      }
      
      if (confirm('FINAL WARNING: This will permanently delete ALL data and cannot be undone. Are you absolutely sure?')) {
        resetApp();
      }
    }
    
    function resetApp() {
      try {
        // Clear all localStorage data
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.startsWith('activityLog_') || 
                      key.startsWith('moodAnalytics_') || 
                      key.startsWith('customActivities_') || 
                      key.startsWith('milestones_') || 
                      key.startsWith('growthData_') || 
                      key.startsWith('feedingSchedules_') || 
                      key.startsWith('reminders_') || 
                      key.startsWith('appointments_') || 
                      key.startsWith('inventory_') ||
                      key === 'babyProfiles' ||
                      key === 'currentProfileId' ||
                      key === 'darkMode')) {
            keysToRemove.push(key);
          }
        }
        
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        // Reset all global state
        babyProfiles = [];
        currentProfileId = null;
        activityLog = [];
        moodAnalytics = { total: 0, moods: {} };
        customActivities = [];
        milestones = [];
        growthData = [];
        feedingSchedules = [];
        reminders = [];
        appointments = [];
        inventory = { diapers: 0, wipes: 0, formula: 0, medicine: 0 };
        
        // Reset timer state
        if (timerState.interval) {
          clearInterval(timerState.interval);
        }
        timerState = {
          isRunning: false,
          startTime: null,
          currentActivity: null,
          interval: null,
          elapsed: 0
        };
        
        // Hide all modals
        hideModal('reset-app-modal');
        hideModal('profile-modal');
        
        // Show success message
        showResetSuccessMessage();
        
        // Redirect to welcome screen after a short delay
        setTimeout(() => {
          showModal('welcome-modal');
        }, 2000);
        
      } catch (error) {
        console.error('Error during app reset:', error);
        alert('An error occurred during the reset. Please try again.');
      }
    }
    
    function showResetSuccessMessage() {
      // Create a success notification
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50 animate-bounce';
      notification.innerHTML = `
        <div class="flex items-center space-x-3">
          <i class="fas fa-check-circle text-2xl"></i>
          <div>
            <div class="font-bold">App Reset Complete!</div>
            <div class="text-sm">All data has been deleted. Starting fresh...</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Remove notification after 3 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }
    
    // Setup reset confirmation input handler
    function setupResetConfirmation() {
      const resetInput = document.getElementById('reset-confirmation');
      const resetBtn = document.getElementById('reset-confirm-btn');
      
      if (resetInput && resetBtn) {
        resetInput.addEventListener('input', function() {
          const confirmation = this.value.trim();
          if (confirmation === 'RESET') {
            resetBtn.disabled = false;
            resetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          } else {
            resetBtn.disabled = true;
            resetBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        });
        
        // Clear input when modal is shown
        resetInput.addEventListener('focus', function() {
          this.value = '';
          resetBtn.disabled = true;
          resetBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });
      }
    }
    
    function showGrowthChart(chartType) {
      const chartContainer = $('#growth-chart');
      if (!chartContainer) return;
      
      // Filter data by type
      const typeMap = {
        'weight': 'weight',
        'height': 'height',
        'head': 'head-circumference'
      };
      
      const targetType = typeMap[chartType];
      const filteredData = growthData.filter(m => m.type === targetType);
      
      if (filteredData.length === 0) {
        chartContainer.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-chart-line text-4xl text-gray-400 mb-4"></i>
            <p class="text-secondary">No ${chartType} data available</p>
            <p class="text-sm text-secondary mt-2">Add some measurements to see your growth chart!</p>
          </div>
        `;
        return;
      }
      
      // Sort by date
      filteredData.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      // Create simple bar chart using CSS
      const chartHtml = createSimpleChart(filteredData, chartType);
      chartContainer.innerHTML = chartHtml;
    }
    
    function createSimpleChart(data, chartType) {
      if (data.length === 0) return '<p class="text-secondary">No data available</p>';
      
      const maxValue = Math.max(...data.map(d => d.value));
      const minValue = Math.min(...data.map(d => d.value));
      const valueRange = maxValue - minValue;
      
      let html = `
        <div class="space-y-4">
          <h4 class="font-semibold text-center capitalize">${chartType} Growth Chart</h4>
          <div class="flex items-end justify-center space-x-2 h-48">
      `;
      
      data.forEach((measurement, index) => {
        const height = valueRange > 0 ? ((measurement.value - minValue) / valueRange) * 100 : 50;
        const date = new Date(measurement.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        // Format display value
        let displayValue = measurement.value;
        if (measurement.unit === 'ft-in') {
          const totalInches = measurement.value;
          const feet = Math.floor(totalInches / 12);
          const inches = Math.round(totalInches % 12);
          displayValue = `${feet}-${inches}`;
        } else if (measurement.unit === 'm-cm') {
          const totalCm = measurement.value;
          const meters = Math.floor(totalCm / 100);
          const centimeters = Math.round(totalCm % 100);
          displayValue = `${meters}-${centimeters}`;
        } else {
          displayValue = Math.round(measurement.value * 10) / 10;
        }
        
        html += `
          <div class="flex flex-col items-center">
            <div class="bg-blue-500 hover:bg-blue-600 transition-colors rounded-t w-8 relative group" 
                 style="height: ${Math.max(height, 10)}%">
              <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                ${displayValue} ${measurement.unit}
              </div>
            </div>
            <div class="text-xs text-secondary mt-2 text-center">${date}</div>
          </div>
        `;
      });
      
      html += `
          </div>
          <div class="text-center text-sm text-secondary">
            <div class="flex justify-between items-center">
              <span>${minValue} ${data[0]?.unit || ''}</span>
              <span>${maxValue} ${data[0]?.unit || ''}</span>
            </div>
          </div>
        </div>
      `;
      
      return html;
    }
    // ... existing code ...
    function updateHeaderStats() {
      const statsBar = document.getElementById('header-stats-bar');
      if (!statsBar) return;

      // Get latest measurements
      const latestWeight = [...growthData].filter(m => m.type === 'weight').sort((a, b) => new Date(b.date) - new Date(a.date))[0];
      const latestHeight = [...growthData].filter(m => m.type === 'height').sort((a, b) => new Date(b.date) - new Date(a.date))[0];
      const latestHead = [...growthData].filter(m => m.type === 'head-circumference').sort((a, b) => new Date(b.date) - new Date(a.date))[0];

      // Get profile and age
      const profile = babyProfiles.find(p => p.id == currentProfileId);
      const age = profile ? calculatePreciseAge(profile.dob) : '-';

      // Format helpers
      function formatValue(measurement) {
        if (!measurement) return '-';
        let v = measurement.value;
        if (measurement.unit === 'ft-in') {
          const feet = Math.floor(v / 12);
          const inches = Math.round(v % 12);
          return `${feet} ft ${inches} in`;
        } else if (measurement.unit === 'm-cm') {
          const meters = Math.floor(v / 100);
          const centimeters = Math.round(v % 100);
          return `${meters} m ${centimeters} cm`;
        } else {
          return `${Math.round(v * 10) / 10} ${measurement.unit}`;
        }
      }

      statsBar.innerHTML = `
        <div class="flex flex-col items-center">
          <div class="text-xs text-secondary">Age</div>
          <div class="font-bold text-lg flex items-center gap-1"><i class="fas fa-baby text-pink-400"></i> ${age}</div>
        </div>
        <div class="flex flex-col items-center">
          <div class="text-xs text-secondary">Current Weight</div>
          <div class="font-bold text-lg flex items-center gap-1"><i class="fas fa-weight-scale text-red-400"></i> ${formatValue(latestWeight)}</div>
        </div>
        <div class="flex flex-col items-center">
          <div class="text-xs text-secondary">Current Height</div>
          <div class="font-bold text-lg flex items-center gap-1"><i class="fas fa-ruler-vertical text-green-400"></i> ${formatValue(latestHeight)}</div>
        </div>
        <div class="flex flex-col items-center">
          <div class="text-xs text-secondary">Head Circumference</div>
          <div class="font-bold text-lg flex items-center gap-1"><i class="fas fa-circle text-purple-400"></i> ${formatValue(latestHead)}</div>
        </div>
      `;
    }
    // ... existing code ...
    
    // --- FEED QUANTITY TOGGLE ---
    function toggleFeedQuantityField() {
      const activityType = document.getElementById('activity-type').value;
      const quantitySection = document.getElementById('feed-quantity-section');
      const moodSection = document.getElementById('mood-section');
      const inventorySection = document.getElementById('inventory-status-section');
      
      // Show/hide quantity field for feed activities
      if (activityType === 'feed') {
        quantitySection.classList.remove('hidden');
        // Reset feed type and quantity fields
        document.getElementById('feed-type').value = '';
        document.getElementById('feed-quantity').value = '';
      } else {
        quantitySection.classList.add('hidden');
      }
      
      // Show/hide mood field for mood activities
      if (activityType === 'mood') {
        moodSection.classList.remove('hidden');
      } else {
        moodSection.classList.add('hidden');
      }
      
      // Show/hide and update inventory status for activities that use inventory
      if (activityType === 'diaper' || activityType === 'feed' || activityType === 'medication') {
        inventorySection.classList.remove('hidden');
        updateInventoryImpact(activityType);
      } else {
        inventorySection.classList.add('hidden');
      }
    }
    
    function updateFeedInventoryImpact() {
      const feedType = document.getElementById('feed-type')?.value;
      const quantity = document.getElementById('feed-quantity')?.value;
      const impactItems = document.getElementById('inventory-impact-items');
      
      if (!impactItems || feedType !== 'formula') {
        return;
      }
      
      let items = [];
      
      if (feedType === 'formula' && quantity && parseFloat(quantity) > 0) {
        const bottlesNeeded = Math.ceil(parseFloat(quantity) / 4);
        items.push({
          item: 'Formula',
          amount: `${bottlesNeeded} bottle${bottlesNeeded > 1 ? 's' : ''} (${quantity} oz)`,
          available: inventory.formula,
          icon: 'fas fa-baby-carriage',
          color: 'purple-500'
        });
      } else {
        items.push({
          item: 'Formula',
          amount: 'Based on quantity',
          available: inventory.formula,
          icon: 'fas fa-baby-carriage',
          color: 'purple-500'
        });
      }
      
      impactItems.innerHTML = items.map(item => `
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <i class="${item.icon} text-${item.color}"></i>
            <span>${item.item}: ${item.amount}</span>
          </div>
          <div class="text-right">
            <span class="font-medium">${item.available} available</span>
            ${item.available === 0 ? '<span class="text-red-500 ml-1">‚ö†Ô∏è</span>' : ''}
          </div>
        </div>
      `).join('');
    }
    
    function updateInventoryImpact(activityType) {
      const impactItems = document.getElementById('inventory-impact-items');
      if (!impactItems) return;
      
      let items = [];
      
      switch (activityType) {
        case 'diaper':
          items.push({
            item: 'Diapers',
            amount: '1',
            available: inventory.diapers,
            icon: 'fas fa-baby',
            color: 'amber-500'
          });
          items.push({
            item: 'Wipes',
            amount: '2',
            available: inventory.wipes,
            icon: 'fas fa-wind',
            color: 'blue-500'
          });
          break;
          
        case 'feed':
          // This will be updated when feed type and quantity are selected
          items.push({
            item: 'Formula',
            amount: 'Based on quantity',
            available: inventory.formula,
            icon: 'fas fa-baby-carriage',
            color: 'purple-500'
          });
          break;
          
        case 'medication':
          items.push({
            item: 'Medicine',
            amount: '1 dose',
            available: inventory.medicine,
            icon: 'fas fa-pills',
            color: 'cyan-500'
          });
          break;
      }
      
      impactItems.innerHTML = items.map(item => `
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <i class="${item.icon} text-${item.color}"></i>
            <span>${item.item}: ${item.amount}</span>
          </div>
          <div class="text-right">
            <span class="font-medium">${item.available} available</span>
            ${item.available === 0 ? '<span class="text-red-500 ml-1">‚ö†Ô∏è</span>' : ''}
          </div>
        </div>
      `).join('');
    }
    
    function updateEditInventoryImpact(activityType, quantity = null, feedType = null) {
      const impactItems = document.getElementById('edit-inventory-impact-items');
      if (!impactItems) return;
      
      let items = [];
      
      switch (activityType) {
        case 'diaper':
          items.push({
            item: 'Diapers',
            amount: '1',
            available: inventory.diapers,
            icon: 'fas fa-baby',
            color: 'amber-500'
          });
          items.push({
            item: 'Wipes',
            amount: '2',
            available: inventory.wipes,
            icon: 'fas fa-wind',
            color: 'blue-500'
          });
          break;
          
        case 'feed':
          if (feedType === 'formula' && quantity && quantity > 0) {
            const bottlesNeeded = Math.ceil(quantity / 4);
            items.push({
              item: 'Formula',
              amount: `${bottlesNeeded} bottle${bottlesNeeded > 1 ? 's' : ''} (${quantity} oz)`,
              available: inventory.formula,
              icon: 'fas fa-baby-carriage',
              color: 'purple-500'
            });
          } else {
            items.push({
              item: 'Formula',
              amount: 'Based on quantity',
              available: inventory.formula,
              icon: 'fas fa-baby-carriage',
              color: 'purple-500'
            });
          }
          break;
          
        case 'medication':
          items.push({
            item: 'Medicine',
            amount: '1 dose',
            available: inventory.medicine,
            icon: 'fas fa-pills',
            color: 'cyan-500'
          });
          break;
      }
      
      impactItems.innerHTML = items.map(item => `
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <i class="${item.icon} text-${item.color}"></i>
            <span>${item.item}: ${item.amount}</span>
          </div>
          <div class="text-right">
            <span class="font-medium">${item.available} available</span>
            ${item.available === 0 ? '<span class="text-red-500 ml-1">‚ö†Ô∏è</span>' : ''}
          </div>
        </div>
      `).join('');
    }
    
    function toggleEditFeedQuantityField() {
      const activityType = document.getElementById('edit-activity-type').value;
      const quantitySection = document.getElementById('edit-feed-quantity-section');
      const moodSection = document.getElementById('edit-mood-section');
      const inventorySection = document.getElementById('edit-inventory-status-section');
      
      // Show/hide quantity field for feed activities
      if (activityType === 'feed') {
        quantitySection.classList.remove('hidden');
        // Reset feed type and quantity fields
        document.getElementById('edit-feed-type').value = '';
        document.getElementById('edit-feed-quantity').value = '';
      } else {
        quantitySection.classList.add('hidden');
      }
      
      // Show/hide mood field for mood activities
      if (activityType === 'mood') {
        moodSection.classList.remove('hidden');
      } else {
        moodSection.classList.add('hidden');
      }
      
      // Show/hide and update inventory status for activities that use inventory
      if (activityType === 'diaper' || activityType === 'feed' || activityType === 'medication') {
        inventorySection.classList.remove('hidden');
        updateEditInventoryImpact(activityType);
      } else {
        inventorySection.classList.add('hidden');
      }
    }
    function quickLogDiaper(diaperType) {
      const now = new Date();
      const timestamp = now.toISOString().slice(0, 16);
      
      // Log the diaper activity immediately
      addEntry(diaperType, timestamp, '', null, null, null);
      
      // Close the diaper modal
      hideModal('diaper-modal');
    }
    
    // Make functions globally available
    window.quickLogDiaper = quickLogDiaper;
  </script>
</body>
</html>
